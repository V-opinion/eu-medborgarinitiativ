"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2944],{10893:function(t,e,n){n.d(e,{OU:function(){return T},Pz:function(){return at},VB:function(){return on},WO:function(){return We},W_:function(){return rt},Wy:function(){return je},Xd:function(){return un},YF:function(){return He},Zb:function(){return f},Ze:function(){return be},eI:function(){return nn},iV:function(){return m},iz:function(){return Oe},l8:function(){return h},nn:function(){return p},rU:function(){return ze},sE:function(){return $e},x3:function(){return dn},yO:function(){return L}});var i=Object.defineProperty,o="@liveblocks/core",s="2.0.5",r="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:{},a="https://liveblocks.io/docs/errors/cross-linked",c="https://liveblocks.io/docs/errors/dupes",d=" ";function u(t){console.error(t)}function h(t,e,n){const i=Symbol.for(t),h=n?`${e||"dev"} (${n})`:e||"dev";if(r[i])if(r[i]===h);else{u([`Multiple copies of Liveblocks are being loaded in your project. This will cause issues! See ${c+d}`,"","Conflicts:",`- ${t} ${r[i]} (already loaded)`,`- ${t} ${h} (trying to load this now)`].join("\n"))}else r[i]=h;e&&s&&e!==s&&u([`Cross-linked versions of Liveblocks found, which will cause issues! See ${a+d}`,"","Conflicts:",`- ${o} is at ${s}`,`- ${t} is at ${e}`,"","Always upgrade all Liveblocks packages to the same version number."].join("\n"))}function l(t,e){throw new Error(e)}function p(t,e="Expected value to be non-nullable"){return t}function f(){const t=new Set,e=new Set;let n=null;function i(t){return e.add(t),()=>e.delete(t)}function o(e){return t.add(e),()=>t.delete(e)}async function s(t){let e;return new Promise((n=>{e=i((e=>{(void 0===t||t(e))&&n(e)}))})).finally((()=>e?.()))}function r(n){t.forEach((t=>t(n))),t.clear(),e.forEach((t=>t(n)))}return{notify:function(t){null!==n?n.push(t):r(t)},subscribe:i,subscribeOnce:o,clear:function(){t.clear(),e.clear()},count:function(){return t.size+e.size},waitUntil:s,pause:function(){n=[]},unpause:function(){if(null!==n){for(const t of n)r(t);n=null}},observable:{subscribe:i,subscribeOnce:o,waitUntil:s}}}var m={};((t,e)=>{for(var n in e)i(t,n,{get:e[n],enumerable:!0})})(m,{error:()=>b,errorWithTitle:()=>I,warn:()=>g,warnWithTitle:()=>w});var y="background:#0e0d12;border-radius:9999px;color:#fff;padding:3px 7px;font-family:sans-serif;font-weight:600;";function _(t){return"undefined"===typeof window?console[t]:(e,...n)=>console[t]("%cLiveblocks",y,e,...n)}var g=_("warn"),b=_("error");function v(t){return"undefined"===typeof window?console[t]:(e,n,...i)=>console[t](`%cLiveblocks%c ${e}`,y,"font-weight:600",n,...i)}var w=v("warn"),I=v("error");var k=class{constructor(t){this.curr=t}get current(){return this.curr}allowPatching(t){const e=this;let n=!0;t({...this.curr,patch(t){if(!n)throw new Error("Can no longer patch stale context");e.curr=Object.assign({},e.curr,t);for(const e of Object.entries(t)){const[t,n]=e;"patch"!==t&&(this[t]=n)}}}),n=!1}},E=1,S=class{get initialState(){const t=this.states.values()[Symbol.iterator]().next();if(t.done)throw new Error("No states defined yet");return t.value}get currentState(){if(null===this.currentStateOrNull)throw 0===this.runningState?new Error("Not started yet"):new Error("Already stopped");return this.currentStateOrNull}start(){if(0!==this.runningState)throw new Error("State machine has already started");return this.runningState=1,this.currentStateOrNull=this.initialState,this.enter(null),this}stop(){if(1!==this.runningState)throw new Error("Cannot stop a state machine that hasn't started yet");this.exit(null),this.runningState=2,this.currentStateOrNull=null}constructor(t){this.id=E++,this.runningState=0,this.currentStateOrNull=null,this.states=new Set,this.enterFns=new Map,this.cleanupStack=[],this.knownEventTypes=new Set,this.allowedTransitions=new Map,this.currentContext=new k(t),this.eventHub={didReceiveEvent:f(),willTransition:f(),didIgnoreEvent:f(),willExitState:f(),didEnterState:f()},this.events={didReceiveEvent:this.eventHub.didReceiveEvent.observable,willTransition:this.eventHub.willTransition.observable,didIgnoreEvent:this.eventHub.didIgnoreEvent.observable,willExitState:this.eventHub.willExitState.observable,didEnterState:this.eventHub.didEnterState.observable}}get context(){return this.currentContext.current}addState(t){if(0!==this.runningState)throw new Error("Already started");return this.states.add(t),this}onEnter(t,e){if(0!==this.runningState)throw new Error("Already started");if(this.enterFns.has(t))throw new Error(`enter/exit function for ${t} already exists`);return this.enterFns.set(t,e),this}onEnterAsync(t,e,n,i){return this.onEnter(t,(()=>{const t=new AbortController,o=t.signal;let s=!1;return e(this.currentContext.current,o).then((t=>{o.aborted||(s=!0,this.transition({type:"ASYNC_OK",data:t},n))}),(t=>{o.aborted||(s=!0,this.transition({type:"ASYNC_ERROR",reason:t},i))})),()=>{s||t.abort()}}))}getStatesMatching(t){const e=[];if("*"===t)for(const n of this.states)e.push(n);else if(t.endsWith(".*")){const n=t.slice(0,-1);for(const t of this.states)t.startsWith(n)&&e.push(t)}else{const n=t;this.states.has(n)&&e.push(n)}if(0===e.length)throw new Error(`No states match ${JSON.stringify(t)}`);return e}addTransitions(t,e){if(0!==this.runningState)throw new Error("Already started");for(const n of this.getStatesMatching(t)){let i=this.allowedTransitions.get(n);void 0===i&&(i=new Map,this.allowedTransitions.set(n,i));for(const[o,s]of Object.entries(e)){if(i.has(o))throw new Error(`Trying to set transition "${o}" on "${n}" (via "${t}"), but a transition already exists there.`);const e=s;if(this.knownEventTypes.add(o),void 0!==e){const t="function"===typeof e?e:()=>e;i.set(o,t)}}}return this}addTimedTransition(t,e,n){return this.onEnter(t,(()=>{const t="function"===typeof e?e(this.currentContext.current):e,i=setTimeout((()=>{this.transition({type:"TIMER"},n)}),t);return()=>{clearTimeout(i)}}))}getTargetFn(t){return this.allowedTransitions.get(this.currentState)?.get(t)}exit(t){this.eventHub.willExitState.notify(this.currentState),this.currentContext.allowPatching((e=>{t=t??this.cleanupStack.length;for(let n=0;n<t;n++)this.cleanupStack.pop()?.(e)}))}enter(t){const e=function(t,e){const n=t.split(".");if(e<1||e>n.length+1)throw new Error("Invalid number of levels");const i=[];e>n.length&&i.push("*");for(let o=n.length-e+1;o<n.length;o++){const t=n.slice(0,o);t.length>0&&i.push(t.join(".")+".*")}return i.push(t),i}(this.currentState,t??this.currentState.split(".").length+1);this.currentContext.allowPatching((t=>{for(const n of e){const e=this.enterFns.get(n),i=e?.(t);"function"===typeof i?this.cleanupStack.push(i):this.cleanupStack.push(null)}})),this.eventHub.didEnterState.notify(this.currentState)}send(t){if(!this.knownEventTypes.has(t.type))throw new Error(`Invalid event ${JSON.stringify(t.type)}`);if(2===this.runningState)return;const e=this.getTargetFn(t.type);if(void 0!==e)return this.transition(t,e);this.eventHub.didIgnoreEvent.notify(t)}transition(t,e){this.eventHub.didReceiveEvent.notify(t);const n=this.currentState,i=("function"===typeof e?e:()=>e)(t,this.currentContext.current);let o,s;if(null===i)return void this.eventHub.didIgnoreEvent.notify(t);if("string"===typeof i?o=i:(o=i.target,s=Array.isArray(i.effect)?i.effect:[i.effect]),!this.states.has(o))throw new Error(`Invalid next state name: ${JSON.stringify(o)}`);this.eventHub.willTransition.notify({from:n,to:o});const[r,a]=function(t,e){if(t===e)return[0,0];const n=t.split("."),i=e.split("."),o=Math.min(n.length,i.length);let s=0;for(;s<o&&n[s]===i[s];s++);return[n.length-s,i.length-s]}(this.currentState,o);if(r>0&&this.exit(r),this.currentStateOrNull=o,void 0!==s){const e=s;this.currentContext.allowPatching((n=>{for(const i of e)"function"===typeof i?i(n,t):n.patch(i)}))}a>0&&this.enter(a)}};function T(t){throw new Error(t)}function A(t){return null!==t&&"object"===typeof t&&"[object Object]"===Object.prototype.toString.call(t)}function O(t){return Object.entries(t)}function C(t){try{return JSON.parse(t)}catch(e){return}}function P(t){return JSON.parse(JSON.stringify(t))}function N(t){return t.filter((t=>null!==t&&void 0!==t))}function x(t){const e={...t};return Object.keys(t).forEach((t=>{const n=t;void 0===e[n]&&delete e[n]})),e}async function D(t,e,n){let i;const o=new Promise(((t,o)=>{i=setTimeout((()=>{o(new Error(n))}),e)}));return Promise.race([t,o]).finally((()=>clearTimeout(i)))}var L=(t=>(t[t.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",t[t.USER_JOINED=101]="USER_JOINED",t[t.USER_LEFT=102]="USER_LEFT",t[t.BROADCASTED_EVENT=103]="BROADCASTED_EVENT",t[t.ROOM_STATE=104]="ROOM_STATE",t[t.INITIAL_STORAGE_STATE=200]="INITIAL_STORAGE_STATE",t[t.UPDATE_STORAGE=201]="UPDATE_STORAGE",t[t.REJECT_STORAGE_OP=299]="REJECT_STORAGE_OP",t[t.UPDATE_YDOC=300]="UPDATE_YDOC",t[t.THREAD_CREATED=400]="THREAD_CREATED",t[t.THREAD_DELETED=407]="THREAD_DELETED",t[t.THREAD_METADATA_UPDATED=401]="THREAD_METADATA_UPDATED",t[t.COMMENT_CREATED=402]="COMMENT_CREATED",t[t.COMMENT_EDITED=403]="COMMENT_EDITED",t[t.COMMENT_DELETED=404]="COMMENT_DELETED",t[t.COMMENT_REACTION_ADDED=405]="COMMENT_REACTION_ADDED",t[t.COMMENT_REACTION_REMOVED=406]="COMMENT_REACTION_REMOVED",t))(L||{});function U(t){return 4999===t||t>=4e3&&t<4100}function R(t){return 1013===t||t>=4200&&t<4300}function j(t){const e=t.currentState;switch(e){case"@ok.connected":case"@ok.awaiting-pong":return"connected";case"@idle.initial":return"initial";case"@auth.busy":case"@auth.backoff":case"@connecting.busy":case"@connecting.backoff":case"@idle.zombie":return t.context.successCount>0?"reconnecting":"connecting";case"@idle.failed":return"disconnected";default:return l(0,"Unknown state")}}var K=[250,500,1e3,2e3,4e3,8e3,1e4],M=K[0]-1,$=[2e3,3e4,6e4,3e5],H=class extends Error{constructor(t){super(t)}},z=class extends Error{constructor(t,e){super(t),this.code=e}};function W(t,e){return e.find((e=>e>t))??e[e.length-1]}function F(t){t.patch({backoffDelay:W(t.backoffDelay,K)})}function J(t){t.patch({backoffDelay:W(t.backoffDelay,$)})}function q(t){t.patch({successCount:0})}function V(t,e){const n=2===t?b:1===t?g:()=>{};return()=>{n(e)}}function G(t){const e="Connection to Liveblocks websocket server";return n=>{t instanceof Error?g(`${e} could not be established. ${String(t)}`):g(X(t)?`${e} closed prematurely (code: ${t.code}). Retrying in ${n.backoffDelay}ms.`:`${e} could not be established.`)}}function B(t){const e=[`code: ${t.code}`];return t.reason&&e.push(`reason: ${t.reason}`),t=>{g(`Connection to Liveblocks websocket server closed (${e.join(", ")}). Retrying in ${t.backoffDelay}ms.`)}}var Y=V(1,"Connection to WebSocket closed permanently. Won't retry.");function X(t){return!(t instanceof Error)&&"close"===t.type}var Z=t=>e=>e.patch(t);function Q(t,e){const n=f();n.pause();const i=f();function o(t,e){return()=>{const n=new z(t,e);i.notify(n)}}const s=new S({successCount:0,authValue:null,socket:null,backoffDelay:M}).addState("@idle.initial").addState("@idle.failed").addState("@idle.zombie").addState("@auth.busy").addState("@auth.backoff").addState("@connecting.busy").addState("@connecting.backoff").addState("@ok.connected").addState("@ok.awaiting-pong");s.addTransitions("*",{RECONNECT:{target:"@auth.backoff",effect:[F,q]},DISCONNECT:"@idle.initial"}),s.onEnter("@idle.*",q).addTransitions("@idle.*",{CONNECT:(t,e)=>null!==e.authValue?"@connecting.busy":"@auth.busy"}),s.addTransitions("@auth.backoff",{NAVIGATOR_ONLINE:{target:"@auth.busy",effect:Z({backoffDelay:M})}}).addTimedTransition("@auth.backoff",(t=>t.backoffDelay),"@auth.busy").onEnterAsync("@auth.busy",(()=>D(t.authenticate(),1e4,"Timed out during auth")),(t=>({target:"@connecting.busy",effect:Z({authValue:t.data})})),(t=>t.reason instanceof H?{target:"@idle.failed",effect:[V(2,t.reason.message),o(t.reason.message,-1)]}:{target:"@auth.backoff",effect:[F,V(2,`Authentication failed: ${t.reason instanceof Error?t.reason.message:String(t.reason)}`)]}));const r=t=>s.send({type:"EXPLICIT_SOCKET_ERROR",event:t}),a=t=>s.send({type:"EXPLICIT_SOCKET_CLOSE",event:t}),c=t=>"pong"===t.data?s.send({type:"PONG"}):n.notify(t);function d(t){t&&(t.removeEventListener("error",r),t.removeEventListener("close",a),t.removeEventListener("message",c),t.close())}s.addTransitions("@connecting.backoff",{NAVIGATOR_ONLINE:{target:"@connecting.busy",effect:Z({backoffDelay:M})}}).addTimedTransition("@connecting.backoff",(t=>t.backoffDelay),"@connecting.busy").onEnterAsync("@connecting.busy",(async(n,i)=>{let o=null,s=null;return D(new Promise(((i,d)=>{if(null===n.authValue)throw new Error("No auth authValue");const u=t.createSocket(n.authValue);function h(t){o=t,u.removeEventListener("message",c),d(t)}s=u;const[l,p]=function(){let t;const e=new Promise((e=>{t=e}));if(!t)throw new Error("Should never happen");return[e,t]}();function f(t){const e=C(t.data);104===e?.type&&p()}e.waitForActorId||p(),u.addEventListener("message",c),e.waitForActorId&&u.addEventListener("message",f),u.addEventListener("error",h),u.addEventListener("close",h),u.addEventListener("open",(()=>{u.addEventListener("error",r),u.addEventListener("close",a);const t=()=>{u.removeEventListener("error",h),u.removeEventListener("close",h),u.removeEventListener("message",f)};l.then((()=>{i([u,t])}))}))})),1e4,"Timed out during websocket connection").then((([t,e])=>{if(e(),i.aborted)throw new Error("Aborted");if(o)throw o;return t})).catch((t=>{throw d(s),t}))}),(t=>({target:"@ok.connected",effect:Z({socket:t.data,backoffDelay:M})})),(t=>{const e=t.reason;if(e instanceof H)return{target:"@idle.failed",effect:[V(2,e.message),o(e.message,-1)]};if(X(e)){if(4109===e.code)return"@auth.busy";if(R(e.code))return{target:"@connecting.backoff",effect:[J,G(e)]};if(U(e.code))return{target:"@idle.failed",effect:[V(2,e.reason),o(e.reason,e.code)]}}return{target:"@auth.backoff",effect:[F,G(e)]}}));const u={target:"@ok.awaiting-pong",effect:t=>{t.socket?.send("ping")}},h=()=>{const e="undefined"!==typeof document?document:void 0;return"hidden"===e?.visibilityState&&t.canZombie()?"@idle.zombie":u};if(s.addTimedTransition("@ok.connected",3e4,h).addTransitions("@ok.connected",{NAVIGATOR_OFFLINE:h,WINDOW_GOT_FOCUS:u}),s.addTransitions("@idle.zombie",{WINDOW_GOT_FOCUS:"@connecting.backoff"}),s.onEnter("@ok.*",(t=>{t.patch({successCount:t.successCount+1});const e=setTimeout(n.unpause,0);return t=>{d(t.socket),t.patch({socket:null}),clearTimeout(e),n.pause()}})).addTransitions("@ok.awaiting-pong",{PONG:"@ok.connected"}).addTimedTransition("@ok.awaiting-pong",2e3,{target:"@connecting.busy",effect:V(1,"Received no pong from server, assume implicit connection loss.")}).addTransitions("@ok.*",{EXPLICIT_SOCKET_ERROR:(t,e)=>1===e.socket?.readyState?null:{target:"@connecting.backoff",effect:F},EXPLICIT_SOCKET_CLOSE:t=>{return U(t.event.code)?{target:"@idle.failed",effect:[Y,o(t.event.reason,t.event.code)]}:(e=t.event.code)>=4100&&e<4200?4109===t.event.code?"@auth.busy":{target:"@auth.backoff",effect:[F,B(t.event)]}:R(t.event.code)?{target:"@connecting.backoff",effect:[J,B(t.event)]}:{target:"@connecting.backoff",effect:[F,B(t.event)]};var e}}),"undefined"!==typeof document){const t="undefined"!==typeof document?document:void 0,e="undefined"!==typeof window?window:void 0,n=e??t;s.onEnter("*",(i=>{function o(){s.send({type:"NAVIGATOR_OFFLINE"})}function r(){s.send({type:"NAVIGATOR_ONLINE"})}function a(){"visible"===t?.visibilityState&&s.send({type:"WINDOW_GOT_FOCUS"})}return e?.addEventListener("online",r),e?.addEventListener("offline",o),n?.addEventListener("visibilitychange",a),()=>{n?.removeEventListener("visibilitychange",a),e?.removeEventListener("online",r),e?.removeEventListener("offline",o),d(i.socket)}}))}const l=[],{statusDidChange:p,didConnect:m,didDisconnect:y,unsubscribe:_}=function(t){const e=f(),n=f(),i=f();let o=null;const s=t.events.didEnterState.subscribe((()=>{const s=j(t);s!==o&&e.notify(s),"connected"===o&&"connected"!==s?i.notify():"connected"!==o&&"connected"===s&&n.notify(),o=s}));return{statusDidChange:e.observable,didConnect:n.observable,didDisconnect:i.observable,unsubscribe:s}}(s);return l.push(_),e.enableDebugLogging&&l.push(function(t){const e=(new Date).getTime();function n(...n){g(`${(((new Date).getTime()-e)/1e3).toFixed(2)} [FSM #${t.id}]`,...n)}const i=[t.events.didReceiveEvent.subscribe((t=>n(`Event ${t.type}`))),t.events.willTransition.subscribe((({from:t,to:e})=>n("Transitioning",t,"\u2192",e))),t.events.didIgnoreEvent.subscribe((t=>n("Ignored event",t.type,t,"(current state won't handle it)")))];return()=>{for(const t of i)t()}}(s)),s.start(),{machine:s,cleanups:l,events:{statusDidChange:p,didConnect:m,didDisconnect:y,onMessage:n.observable,onLiveblocksError:i.observable}}}var tt=class{constructor(t,e=!1,n=!0){const{machine:i,events:o,cleanups:s}=Q(t,{waitForActorId:n,enableDebugLogging:e});this.machine=i,this.events=o,this.cleanups=s}getStatus(){try{return j(this.machine)}catch{return"initial"}}get authValue(){return this.machine.context.authValue}connect(){this.machine.send({type:"CONNECT"})}reconnect(){this.machine.send({type:"RECONNECT"})}disconnect(){this.machine.send({type:"DISCONNECT"})}destroy(){let t;for(this.machine.stop();t=this.cleanups.pop();)t()}send(t){const e=this.machine.context?.socket;null===e?g("Cannot send: not connected yet",t):1!==e.readyState?g("Cannot send: WebSocket no longer open",t):e.send(t)}_privateSendMachineEvent(t){this.machine.send(t)}};function et(t){return t.includes("room:write")}function nt(t){return t.includes("comments:write")||t.includes("room:write")}function it(t){const e=t.split(".");if(3!==e.length)throw new Error("Authentication error: invalid JWT token");const n=C(function(t){try{const e=t.replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(e).split("").map((function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(e){return atob(t)}}(e[1]));if(!n||(!A(i=n)||"acc"!==i.k&&"id"!==i.k&&"sec-legacy"!==i.k))throw new Error("Authentication error: expected a valid token but did not get one. Hint: if you are using a callback, ensure the room is passed when creating the token. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientCallback");var i;return{raw:t,parsed:n}}function ot(t){const e=function(t){const{publicApiKey:e,authEndpoint:n}=t;if(void 0!==n&&void 0!==e)throw new Error("You cannot simultaneously use `publicApiKey` and `authEndpoint` options. Please pick one and leave the other option unspecified. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient");if("string"===typeof e){if(e.startsWith("sk_"))throw new Error("Invalid `publicApiKey` option. The value you passed is a secret key, which should not be used from the client. Please only ever pass a public key here. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");if(!e.startsWith("pk_"))throw new Error("Invalid key. Please use the public key format: pk_<public key>. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");return{type:"public",publicApiKey:e}}if("string"===typeof n)return{type:"private",url:n};if("function"===typeof n)return{type:"custom",callback:n};if(void 0!==n)throw new Error("The `authEndpoint` option must be a string or a function. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientAuthEndpoint");throw new Error("Invalid Liveblocks client options. Please provide either a `publicApiKey` or `authEndpoint` option. They cannot both be empty. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient")}(t),n=new Set,i=[],o=[],s=new Map;function r(t,e){return"comments:read"===t?e.includes("comments:read")||e.includes("comments:write")||e.includes("room:read")||e.includes("room:write"):"room:read"===t&&(e.includes("room:read")||e.includes("room:write"))}async function a(i){const o=t.polyfills?.fetch??("undefined"===typeof window?void 0:window.fetch);if("private"===e.type){if(void 0===o)throw new H("To use Liveblocks client in a non-DOM environment with a url as auth endpoint, you need to provide a fetch polyfill.");const t=it((await async function(t,e,n){const i=await t(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok){const t=`${(await i.text()).trim()||"reason not provided in auth response"} (${i.status} returned by POST ${e})`;throw 401===i.status||403===i.status?new H(`Unauthorized: ${t}`):new Error(`Failed to authenticate: ${t}`)}let o;try{o=await i.json()}catch(r){throw new Error(`Expected a JSON response when doing a POST request on "${e}". ${String(r)}`)}if(!A(o)||"string"!==typeof o.token)throw new Error(`Expected a JSON response of the form \`{ token: "..." }\` when doing a POST request on "${e}", but got ${JSON.stringify(o)}`);const{token:s}=o;return{token:s}}(o,e.url,{room:i.roomId})).token);if(n.has(t.raw))throw new H("The same Liveblocks auth token was issued from the backend before. Caching Liveblocks tokens is not supported.");return t}if("custom"===e.type){const t=await e.callback(i.roomId);if(t&&"object"===typeof t){if("string"===typeof t.token){return it(t.token)}if("string"===typeof t.error){const e=`Authentication failed: ${"reason"in t&&"string"===typeof t.reason?t.reason:"Forbidden"}`;throw"forbidden"===t.error?new H(e):new Error(e)}}throw new Error('Your authentication callback function should return a token, but it did not. Hint: the return value should look like: { token: "..." }')}throw new Error("Unexpected authentication type. Must be private or custom.")}return{reset:function(){n.clear(),i.length=0,o.length=0,s.clear()},getAuthValue:async function(t){if("public"===e.type)return{type:"public",publicApiKey:e.publicApiKey};const c=function(t){const e=Math.ceil(Date.now()/1e3);for(let n=i.length-1;n>=0;n--){const s=i[n];if(o[n]<=e)i.splice(n,1),o.splice(n,1);else{if("id"===s.parsed.k)return s;if("acc"===s.parsed.k){if(!t.roomId&&0===Object.entries(s.parsed.perms).length)return s;for(const[e,n]of Object.entries(s.parsed.perms))if(t.roomId){if(e.includes("*")&&t.roomId.startsWith(e.replace("*",""))||t.roomId===e&&r(t.requestedScope,n))return s}else if(e.includes("*")&&r(t.requestedScope,n))return s}}}}(t);if(void 0!==c)return{type:"secret",token:c};let d;t.roomId?(d=s.get(t.roomId),void 0===d&&(d=a(t),s.set(t.roomId,d))):(d=s.get("liveblocks-user-token"),void 0===d&&(d=a(t),s.set("liveblocks-user-token",d)));try{const t=await d,e=30,s=Math.floor(Date.now()/1e3)+(t.parsed.exp-t.parsed.iat)-e;return n.add(t.raw),"sec-legacy"!==t.parsed.k&&(i.push(t),o.push(s)),{type:"secret",token:t}}finally{t.roomId?s.delete(t.roomId):s.delete("liveblocks-user-token")}}}}var st="https://api.liveblocks.io",rt=Symbol();f().observable;Date.now();function at(t,...e){if("object"!==typeof t||null===t||Array.isArray(t))return JSON.stringify(t,...e);const n=Object.keys(t).sort().reduce(((e,n)=>(e[n]=t[n],e)),{});return JSON.stringify(n,...e)}var ct=()=>{},dt=class{constructor(t){this.resolve=ct,this.reject=ct,this.promise=new Promise(ct),this.args=t}},ut=class{constructor(t,e){this.queue=[],this.error=!1,this.callback=t,this.size=e?.size??50,this.delay=e?.delay??100}clearDelayTimeout(){void 0!==this.delayTimeoutId&&(clearTimeout(this.delayTimeoutId),this.delayTimeoutId=void 0)}schedule(){this.queue.length===this.size?this.flush():1===this.queue.length&&(this.clearDelayTimeout(),this.delayTimeoutId=setTimeout((()=>{this.flush()}),this.delay))}async flush(){if(0===this.queue.length)return;const t=this.queue.splice(0),e=t.map((t=>t.args));try{const n=await this.callback(e);this.error=!1,t.forEach(((e,i)=>{const o=n?.[i];Array.isArray(n)?t.length!==n.length?e.reject(new Error(`Callback must return an array of the same length as the number of provided items. Expected ${t.length}, but got ${n.length}.`)):o instanceof Error?e.reject(o):e.resolve(o):e.reject(new Error("Callback must return an array."))}))}catch(n){this.error=!0,t.forEach((t=>{t.reject(n)}))}}get(...t){const e=this.queue.find((e=>at(e.args)===at(t)));if(e)return e.promise;const n=new dt(t);return n.promise=new Promise(((t,e)=>{n.resolve=t,n.reject=e})),this.queue.push(n),this.schedule(),n.promise}clear(){this.queue=[],this.error=!1,this.clearDelayTimeout()}};function ht(t,e){const n=new ut(t,e),i=new Map,o=f();function s(t){return at(t)}function r(t,e){e?i.set(t,e):i.delete(t),o.notify(e)}return{...o,get:async function(...t){const e=s(t);if(!i.has(e))try{r(e,{isLoading:!0});r(e,{isLoading:!1,data:await n.get(...t)})}catch(o){r(e,{isLoading:!1,error:o})}},getState:function(...t){const e=s(t);return i.get(e)}}}function lt(t){let e=t;const n=new Set;return{get:function(){return e},set:function(t){const i=t(e);if(e!==i){e=i;for(const t of n)t(e)}},subscribe:function(t){return n.add(t),t(e),()=>{n.delete(t)}}}}function pt(t){const e=t.editedAt?new Date(t.editedAt):void 0,n=new Date(t.createdAt),i=t.reactions.map((t=>({...t,createdAt:new Date(t.createdAt)})));if(t.body)return{...t,reactions:i,createdAt:n,editedAt:e};{const o=new Date(t.deletedAt);return{...t,reactions:i,createdAt:n,editedAt:e,deletedAt:o}}}function ft(t){const e=t.updatedAt?new Date(t.updatedAt):void 0,n=new Date(t.createdAt),i=t.comments.map((t=>pt(t)));return{...t,createdAt:n,updatedAt:e,comments:i}}function mt(t){const e=new Date(t.notifiedAt),n=t.readAt?new Date(t.readAt):null;if("activities"in t){const i=t.activities.map((t=>({...t,createdAt:new Date(t.createdAt)})));return{...t,notifiedAt:e,readAt:n,activities:i}}return{...t,notifiedAt:e,readAt:n}}function yt(t){const e=new Date(t.deletedAt);return{...t,deletedAt:e}}function _t(t){const e=new Date(t.deletedAt);return{...t,deletedAt:e}}function gt(t,e,n){const i=new URL(e,t);return void 0!==n&&(i.search=(n instanceof URLSearchParams?n:function(t){const e=new URLSearchParams;for(const[n,i]of Object.entries(t))void 0!==i&&null!==i&&e.set(n,i.toString());return e}(n)).toString()),i.toString()}var bt=50;function vt({baseUrl:t,authManager:e,currentUserIdStore:n,fetcher:i}){async function o(o,s,r){const a=await e.getAuthValue({requestedScope:"comments:read"});if("secret"===a.type&&"acc"===a.token.parsed.k){const t=a.token.parsed.uid;n.set((()=>t))}const c=gt(t,`/v2/c${o}`,r),d=await i(c.toString(),{...s,headers:{...s?.headers,Authorization:`Bearer ${en(a)}`}});if(!d.ok&&d.status>=400&&d.status<600){let t;try{const e=await d.json();t=new on(e.message,d.status,e)}catch{t=new on(d.statusText,d.status)}throw t}let u;try{u=await d.json()}catch{u={}}return u}const s=new ut((async t=>{const e=t.flat();return await async function(t){await o("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:t})})}(e),e}),{delay:bt});return{getInboxNotifications:async function(t){const e=await o("/inbox-notifications",void 0,{limit:t?.limit,since:t?.since?.toISOString()});return{threads:e.threads.map((t=>ft(t))),inboxNotifications:e.inboxNotifications.map((t=>mt(t))),deletedThreads:e.deletedThreads.map((t=>yt(t))),deletedInboxNotifications:e.deletedInboxNotifications.map((t=>_t(t))),meta:{requestedAt:new Date(e.meta.requestedAt)}}},getUnreadInboxNotificationsCount:async function(){const{count:t}=await o("/inbox-notifications/count");return t},markAllInboxNotificationsAsRead:async function(){await o("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:"all"})})},markInboxNotificationAsRead:async function(t){await s.get(t)}}}var wt=32,It=126,kt=It-wt+1,Et=At(0),St=At(1),Tt=Et+At(-1);function At(t){const e=wt+(t<0?kt+t:t);if(e<wt||e>It)throw new Error(`Invalid n value: ${t}`);return String.fromCharCode(e)}function Ot(t,e){return void 0!==t&&void 0!==e?function(t,e){if(t<e)return Ct(t,e);if(t>e)return Ct(e,t);throw new Error("Cannot compute value between two equal positions")}(t,e):void 0!==t?function(t){for(let e=0;e<=t.length-1;e++){const n=t.charCodeAt(e);if(!(n>=It))return t.substring(0,e)+String.fromCharCode(n+1)}return t+St}(t):void 0!==e?function(t){const e=t.length-1;for(let n=0;n<=e;n++){const i=t.charCodeAt(n);if(!(i<=wt))return n===e?i===wt+1?t.substring(0,n)+Tt:t.substring(0,n)+String.fromCharCode(i-1):t.substring(0,n+1)}return St}(e):St}function Ct(t,e){let n=0;const i=t.length,o=e.length;for(;;){const a=n<i?t.charCodeAt(n):wt,c=n<o?e.charCodeAt(n):It;if(a!==c){if(c-a===1){const e=n+1;let i=t.substring(0,e);i.length<e&&(i+=Et.repeat(e-i.length));return i+Ct(t.substring(e),"")}return((r=n)<(s=t).length?s.substring(0,r):s+Et.repeat(r-s.length))+String.fromCharCode(c+a>>1)}n++}var s,r}var Pt=wt+1;function Nt(t){return function(t){if(""===t)return!1;const e=t.length-1,n=t.charCodeAt(e);if(n<Pt||n>It)return!1;for(let i=0;i<e;i++){const e=t.charCodeAt(i);if(e<wt||e>It)return!1}return!0}(t)?t:function(t){const e=[];for(let n=0;n<t.length;n++){const i=t.charCodeAt(n);e.push(i<wt?wt:i>It?It:i)}for(;e.length>0&&e[e.length-1]===wt;)e.length--;return e.length>0?String.fromCharCode(...e):St}(t)}function xt(t,e,n=Nt(e)){return Object.freeze({type:"HasParent",node:t,key:e,pos:n})}var Dt=Object.freeze({type:"NoParent"});var Lt=class{constructor(){this._parent=Dt}_getParentKeyOrThrow(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":throw new Error("Parent key is missing");case"Orphaned":return this.parent.oldKey;default:return l(this.parent,"Unknown state")}}get _parentPos(){switch(this.parent.type){case"HasParent":return this.parent.pos;case"NoParent":throw new Error("Parent key is missing");case"Orphaned":return this.parent.oldPos;default:return l(this.parent,"Unknown state")}}get _pool(){return this.__pool}get roomId(){return this.__pool?this.__pool.roomId:null}get _id(){return this.__id}get parent(){return this._parent}get _parentKey(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":return null;case"Orphaned":return this.parent.oldKey;default:return l(this.parent,"Unknown state")}}_apply(t,e){return 5===t.type&&"HasParent"===this.parent.type?this.parent.node._detachChild(this):{modified:!1}}_setParentLink(t,e){switch(this.parent.type){case"HasParent":if(this.parent.node!==t)throw new Error("Cannot set parent: node already has a parent");return void(this._parent=xt(t,e));case"Orphaned":case"NoParent":return void(this._parent=xt(t,e));default:return l(this.parent,"Unknown state")}}_attach(t,e){if(this.__id||this.__pool)throw new Error("Cannot attach node: already attached");e.addNode(t,this),this.__id=t,this.__pool=e}_detach(){switch(this.__pool&&this.__id&&this.__pool.deleteNode(this.__id),this.parent.type){case"HasParent":this._parent=function(t,e=Nt(t)){return Object.freeze({type:"Orphaned",oldKey:t,oldPos:e})}(this.parent.key,this.parent.pos);break;case"NoParent":this._parent=Dt;break;case"Orphaned":break;default:l(this.parent,"Unknown state")}this.__pool=void 0}invalidate(){void 0===this._cachedImmutable&&void 0===this._cachedTreeNode||(this._cachedImmutable=void 0,this._cachedTreeNode=void 0,"HasParent"===this.parent.type&&this.parent.node.invalidate())}toTreeNode(t){return void 0!==this._cachedTreeNode&&this._cachedTreeNodeKey===t||(this._cachedTreeNodeKey=t,this._cachedTreeNode=this._toTreeNode(t)),this._cachedTreeNode}toImmutable(){return void 0===this._cachedImmutable&&(this._cachedImmutable=this._toImmutable()),this._cachedImmutable}};function Ut(t){return 0===t.type&&!function(t){return void 0!==t.parentId&&void 0!==t.parentKey}(t)}function Rt(t=7){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,./;[]~!@#$%&*()_+=-";return Array.from({length:t},(()=>e.charAt(Math.floor(82*Math.random())))).join("")}var jt=class t extends Lt{constructor(t){super(),this._data=t}get data(){return this._data}static _deserialize([e,n],i,o){const s=new t(n.data);return s._attach(e,o),s}_toOps(t,e,n){if(void 0===this._id)throw new Error("Cannot serialize register if parentId or parentKey is undefined");return[{type:8,opId:n?.generateOpId(),id:this._id,parentId:t,parentKey:e,data:this.data}]}_serialize(){if("HasParent"!==this.parent.type)throw new Error("Cannot serialize LiveRegister if parent is missing");return{type:3,parentId:p(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key,data:this.data}}_attachChild(t){throw new Error("Method not implemented.")}_detachChild(t){throw new Error("Method not implemented.")}_apply(t,e){return super._apply(t,e)}_toTreeNode(t){return{type:"Json",id:this._id??Rt(),key:t,payload:this._data}}_toImmutable(){return this._data}clone(){return P(this.data)}};function Kt(t,e){const n=t._parentPos,i=e._parentPos;return n===i?0:n<i?-1:1}var Mt=class t extends Lt{constructor(t){let e;super(),this._items=[],this._implicitlyDeletedItems=new WeakSet,this._unacknowledgedSets=new Map;for(const n of t){const t=Ot(e),i=re(n);i._setParentLink(this,t),this._items.push(i),e=t}}static _deserialize([e],n,i){const o=new t([]);o._attach(e,i);const s=n.get(e);if(void 0===s)return o;for(const[t,r]of s){const e=Qt([t,r],n,i);e._setParentLink(o,r.parentKey),o._insertAndSort(e)}return o}_toOps(t,e,n){if(void 0===this._id)throw new Error("Cannot serialize item is not attached");const i=[],o={id:this._id,opId:n?.generateOpId(),type:2,parentId:t,parentKey:e};i.push(o);for(const s of this._items){const t=s._getParentKeyOrThrow(),e=qt(s._toOps(this._id,t,n),void 0),o=e[0].opId;void 0!==o&&this._unacknowledgedSets.set(t,o),i.push(...e)}return i}_insertAndSort(t){this._items.push(t),this._sortItems()}_sortItems(){this._items.sort(Kt),this.invalidate()}_indexOfPosition(t){return this._items.findIndex((e=>e._getParentKeyOrThrow()===t))}_attach(t,e){super._attach(t,e);for(const n of this._items)n._attach(e.generateId(),e)}_detach(){super._detach();for(const t of this._items)t._detach()}_applySetRemote(t){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");const{id:e,parentKey:n}=t,i=Yt(t);i._attach(e,this._pool),i._setParentLink(this,n);const o=t.deletedId,s=this._indexOfPosition(n);if(-1!==s){const e=this._items[s];if(e._id===o)return e._detach(),this._items[s]=i,{modified:Ht(this,[zt(s,i)]),reverse:[]};{this._implicitlyDeletedItems.add(e),this._items[s]=i;const n=[zt(s,i)],o=this._detachItemAssociatedToSetOperation(t.deletedId);return o&&n.push(o),{modified:Ht(this,n),reverse:[]}}}{const e=[],o=this._detachItemAssociatedToSetOperation(t.deletedId);return o&&e.push(o),this._insertAndSort(i),e.push(Ft(this._indexOfPosition(n),i)),{reverse:[],modified:Ht(this,e)}}}_applySetAck(t){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");const e=[],n=this._detachItemAssociatedToSetOperation(t.deletedId);n&&e.push(n);const i=this._unacknowledgedSets.get(t.parentKey);if(void 0!==i){if(i!==t.opId)return 0===e.length?{modified:!1}:{modified:Ht(this,e),reverse:[]};this._unacknowledgedSets.delete(t.parentKey)}const o=this._indexOfPosition(t.parentKey),s=this._items.find((e=>e._id===t.id));if(void 0!==s){if(s._parentKey===t.parentKey)return{modified:e.length>0&&Ht(this,e),reverse:[]};-1!==o&&(this._implicitlyDeletedItems.add(this._items[o]),this._items.splice(o,1),e.push(Wt(o)));const n=this._items.indexOf(s);s._setParentLink(this,t.parentKey),this._sortItems();const i=this._items.indexOf(s);return i!==n&&e.push(Jt(n,i,s)),{modified:e.length>0&&Ht(this,e),reverse:[]}}{const n=this._pool.getNode(t.id);if(n&&this._implicitlyDeletedItems.has(n)){n._setParentLink(this,t.parentKey),this._implicitlyDeletedItems.delete(n),this._insertAndSort(n);const i=this._items.indexOf(n);return{modified:Ht(this,[-1===o?Ft(i,n):zt(i,n),...e]),reverse:[]}}{-1!==o&&this._items.splice(o,1);const{newItem:n,newIndex:i}=this._createAttachItemAndSort(t,t.parentKey);return{modified:Ht(this,[-1===o?Ft(i,n):zt(i,n),...e]),reverse:[]}}}}_detachItemAssociatedToSetOperation(t){if(void 0===t||void 0===this._pool)return null;const e=this._pool.getNode(t);if(void 0===e)return null;const n=this._detachChild(e);return!1===n.modified?null:n.modified.updates[0]}_applyRemoteInsert(t){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");const e=Nt(t.parentKey),n=this._indexOfPosition(e);-1!==n&&this._shiftItemPosition(n,e);const{newItem:i,newIndex:o}=this._createAttachItemAndSort(t,e);return{modified:Ht(this,[Ft(o,i)]),reverse:[]}}_applyInsertAck(t){const e=this._items.find((e=>e._id===t.id)),n=Nt(t.parentKey),i=this._indexOfPosition(n);if(e){if(e._parentKey===n)return{modified:!1};{const t=this._items.indexOf(e);-1!==i&&this._shiftItemPosition(i,n),e._setParentLink(this,n),this._sortItems();const o=this._indexOfPosition(n);return o===t?{modified:!1}:{modified:Ht(this,[Jt(t,o,e)]),reverse:[]}}}{const e=p(this._pool).getNode(t.id);if(e&&this._implicitlyDeletedItems.has(e)){e._setParentLink(this,n),this._implicitlyDeletedItems.delete(e),this._insertAndSort(e);return{modified:Ht(this,[Ft(this._indexOfPosition(n),e)]),reverse:[]}}{-1!==i&&this._shiftItemPosition(i,n);const{newItem:e,newIndex:o}=this._createAttachItemAndSort(t,n);return{modified:Ht(this,[Ft(o,e)]),reverse:[]}}}}_applyInsertUndoRedo(t){const{id:e,parentKey:n}=t,i=Yt(t);if(void 0!==this._pool?.getNode(e))return{modified:!1};i._attach(e,p(this._pool)),i._setParentLink(this,n);const o=this._indexOfPosition(n);let s=n;if(-1!==o){const t=this._items[o]?._parentPos,e=this._items[o+1]?._parentPos;s=Ot(t,e),i._setParentLink(this,s)}this._insertAndSort(i);return{modified:Ht(this,[Ft(this._indexOfPosition(s),i)]),reverse:[{type:5,id:e}]}}_applySetUndoRedo(t){const{id:e,parentKey:n}=t,i=Yt(t);if(void 0!==this._pool?.getNode(e))return{modified:!1};this._unacknowledgedSets.set(n,p(t.opId));const o=this._indexOfPosition(n);i._attach(e,p(this._pool)),i._setParentLink(this,n);const s=n;if(-1!==o){const e=this._items[o];e._detach(),this._items[o]=i;const s=qt(e._toOps(p(this._id),n,this._pool),t.id),r=[zt(o,i)],a=this._detachItemAssociatedToSetOperation(t.deletedId);return a&&r.push(a),{modified:Ht(this,r),reverse:s}}this._insertAndSort(i),this._detachItemAssociatedToSetOperation(t.deletedId);return{reverse:[{type:5,id:e}],modified:Ht(this,[Ft(this._indexOfPosition(s),i)])}}_attachChild(t,e){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");let n;return n="set"===t.intent?1===e?this._applySetRemote(t):2===e?this._applySetAck(t):this._applySetUndoRedo(t):1===e?this._applyRemoteInsert(t):2===e?this._applyInsertAck(t):this._applyInsertUndoRedo(t),!1!==n.modified&&this.invalidate(),n}_detachChild(t){if(t){const e=p(t._parentKey),n=t._toOps(p(this._id),e,this._pool),i=this._items.indexOf(t);return-1===i?{modified:!1}:(this._items.splice(i,1),this.invalidate(),t._detach(),{modified:Ht(this,[Wt(i)]),reverse:n})}return{modified:!1}}_applySetChildKeyRemote(t,e){if(this._implicitlyDeletedItems.has(e)){this._implicitlyDeletedItems.delete(e),e._setParentLink(this,t),this._insertAndSort(e);return{modified:Ht(this,[Ft(this._items.indexOf(e),e)]),reverse:[]}}if(t===e._parentKey)return{modified:!1};const n=this._indexOfPosition(t);if(-1===n){const n=this._items.indexOf(e);e._setParentLink(this,t),this._sortItems();const i=this._items.indexOf(e);return i===n?{modified:!1}:{modified:Ht(this,[Jt(n,i,e)]),reverse:[]}}{this._items[n]._setParentLink(this,Ot(t,this._items[n+1]?._parentPos));const i=this._items.indexOf(e);e._setParentLink(this,t),this._sortItems();const o=this._items.indexOf(e);return o===i?{modified:!1}:{modified:Ht(this,[Jt(i,o,e)]),reverse:[]}}}_applySetChildKeyAck(t,e){const n=p(e._parentKey);if(this._implicitlyDeletedItems.has(e)){const n=this._indexOfPosition(t);return this._implicitlyDeletedItems.delete(e),-1!==n&&this._items[n]._setParentLink(this,Ot(t,this._items[n+1]?._parentPos)),e._setParentLink(this,t),this._insertAndSort(e),{modified:!1}}{if(t===n)return{modified:!1};const i=this._items.indexOf(e),o=this._indexOfPosition(t);-1!==o&&this._items[o]._setParentLink(this,Ot(t,this._items[o+1]?._parentPos)),e._setParentLink(this,t),this._sortItems();const s=this._items.indexOf(e);return i===s?{modified:!1}:{modified:Ht(this,[Jt(i,s,e)]),reverse:[]}}}_applySetChildKeyUndoRedo(t,e){const n=p(e._parentKey),i=this._items.indexOf(e),o=this._indexOfPosition(t);-1!==o&&this._items[o]._setParentLink(this,Ot(t,this._items[o+1]?._parentPos)),e._setParentLink(this,t),this._sortItems();const s=this._items.indexOf(e);return i===s?{modified:!1}:{modified:Ht(this,[Jt(i,s,e)]),reverse:[{type:1,id:p(e._id),parentKey:n}]}}_setChildKey(t,e,n){return 1===n?this._applySetChildKeyRemote(t,e):2===n?this._applySetChildKeyAck(t,e):this._applySetChildKeyUndoRedo(t,e)}_apply(t,e){return super._apply(t,e)}_serialize(){if("HasParent"!==this.parent.type)throw new Error("Cannot serialize LiveList if parent is missing");return{type:1,parentId:p(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get length(){return this._items.length}push(t){return this._pool?.assertStorageIsWritable(),this.insert(t,this.length)}insert(t,e){if(this._pool?.assertStorageIsWritable(),e<0||e>this._items.length)throw new Error(`Cannot insert list item at index "\x1d${e}". index should be between 0 and ${this._items.length}`);const n=Ot(this._items[e-1]?this._items[e-1]._parentPos:void 0,this._items[e]?this._items[e]._parentPos:void 0),i=re(t);if(i._setParentLink(this,n),this._insertAndSort(i),this._pool&&this._id){const t=this._pool.generateId();i._attach(t,this._pool),this._pool.dispatch(i._toOps(this._id,n,this._pool),[{type:5,id:t}],new Map([[this._id,Ht(this,[Ft(e,i)])]]))}}move(t,e){if(this._pool?.assertStorageIsWritable(),e<0)throw new Error("targetIndex cannot be less than 0");if(e>=this._items.length)throw new Error("targetIndex cannot be greater or equal than the list length");if(t<0)throw new Error("index cannot be less than 0");if(t>=this._items.length)throw new Error("index cannot be greater or equal than the list length");let n=null,i=null;t<e?(i=e===this._items.length-1?void 0:this._items[e+1]._parentPos,n=this._items[e]._parentPos):(i=this._items[e]._parentPos,n=0===e?void 0:this._items[e-1]._parentPos);const o=Ot(n,i),s=this._items[t],r=s._getParentKeyOrThrow();if(s._setParentLink(this,o),this._sortItems(),this._pool&&this._id){const n=new Map([[this._id,Ht(this,[Jt(t,e,s)])]]);this._pool.dispatch([{type:1,id:p(s._id),opId:this._pool.generateOpId(),parentKey:o}],[{type:1,id:p(s._id),parentKey:r}],n)}}delete(t){if(this._pool?.assertStorageIsWritable(),t<0||t>=this._items.length)throw new Error(`Cannot delete list item at index "${t}". index should be between 0 and ${this._items.length-1}`);const e=this._items[t];if(e._detach(),this._items.splice(t,1),this.invalidate(),this._pool){const n=e._id;if(n){const i=new Map;i.set(p(this._id),Ht(this,[Wt(t)])),this._pool.dispatch([{id:n,opId:this._pool.generateOpId(),type:5}],e._toOps(p(this._id),e._getParentKeyOrThrow()),i)}}}clear(){if(this._pool?.assertStorageIsWritable(),this._pool){const t=[],e=[],n=[];for(const o of this._items){o._detach();const i=o._id;i&&(t.push({type:5,id:i,opId:this._pool.generateOpId()}),e.push(...o._toOps(p(this._id),o._getParentKeyOrThrow())),n.push(Wt(0)))}this._items=[],this.invalidate();const i=new Map;i.set(p(this._id),Ht(this,n)),this._pool.dispatch(t,e,i)}else{for(const t of this._items)t._detach();this._items=[],this.invalidate()}}set(t,e){if(this._pool?.assertStorageIsWritable(),t<0||t>=this._items.length)throw new Error(`Cannot set list item at index "\x1d${t}". index should be between 0 and ${this._items.length-1}`);const n=this._items[t],i=n._getParentKeyOrThrow(),o=n._id;n._detach();const s=re(e);if(s._setParentLink(this,i),this._items[t]=s,this.invalidate(),this._pool&&this._id){const e=this._pool.generateId();s._attach(e,this._pool);const r=new Map;r.set(this._id,Ht(this,[zt(t,s)]));const a=qt(s._toOps(this._id,i,this._pool),o);this._unacknowledgedSets.set(i,p(a[0].opId));const c=qt(n._toOps(this._id,i,void 0),e);this._pool.dispatch(a,c,r)}}toArray(){return this._items.map((t=>se(t)))}every(t){return this.toArray().every(t)}filter(t){return this.toArray().filter(t)}find(t){return this.toArray().find(t)}findIndex(t){return this.toArray().findIndex(t)}forEach(t){return this.toArray().forEach(t)}get(t){if(!(t<0||t>=this._items.length))return se(this._items[t])}indexOf(t,e){return this.toArray().indexOf(t,e)}lastIndexOf(t,e){return this.toArray().lastIndexOf(t,e)}map(t){return this._items.map(((e,n)=>t(se(e),n)))}some(t){return this.toArray().some(t)}[Symbol.iterator](){return new $t(this._items)}_createAttachItemAndSort(t,e){const n=Yt(t);n._attach(t.id,p(this._pool)),n._setParentLink(this,e),this._insertAndSort(n);return{newItem:n,newIndex:this._indexOfPosition(e)}}_shiftItemPosition(t,e){const n=Ot(e,this._items.length>t+1?this._items[t+1]?._parentPos:void 0);this._items[t]._setParentLink(this,n)}_toTreeNode(t){return{type:"LiveList",id:this._id??Rt(),key:t,payload:this._items.map(((t,e)=>t.toTreeNode(e.toString())))}}toImmutable(){return super.toImmutable()}_toImmutable(){return this._items.map((t=>t.toImmutable()))}clone(){return new t(this._items.map((t=>t.clone())))}},$t=class{constructor(t){this._innerIterator=t[Symbol.iterator]()}[Symbol.iterator](){return this}next(){const t=this._innerIterator.next();if(t.done)return{done:!0,value:void 0};return{value:se(t.value)}}};function Ht(t,e){return{node:t,type:"LiveList",updates:e}}function zt(t,e){return{index:t,type:"set",item:e instanceof jt?e.data:e}}function Wt(t){return{index:t,type:"delete"}}function Ft(t,e){return{index:t,type:"insert",item:e instanceof jt?e.data:e}}function Jt(t,e,n){return{index:e,type:"move",previousIndex:t,item:n instanceof jt?n.data:n}}function qt(t,e){return t.map(((t,n)=>{if(0===n){return{...t,intent:"set",deletedId:e}}return t}))}var Vt=t=>t,Gt=class t extends Lt{constructor(t){if(super(),this.unacknowledgedSet=new Map,t){const e=[];for(const[n,i]of t){const t=re(i);t._setParentLink(this,n),e.push([n,t])}this._map=new Map(e)}else this._map=new Map}_toOps(t,e,n){if(void 0===this._id)throw new Error("Cannot serialize item is not attached");const i=[],o={id:this._id,opId:n?.generateOpId(),type:7,parentId:t,parentKey:e};i.push(o);for(const[s,r]of this._map)i.push(...r._toOps(this._id,s,n));return i}static _deserialize([e,n],i,o){const s=new t;s._attach(e,o);const r=i.get(e);if(void 0===r)return s;for(const[t,a]of r){const e=Qt([t,a],i,o);e._setParentLink(s,a.parentKey),s._map.set(a.parentKey,e),s.invalidate()}return s}_attach(t,e){super._attach(t,e);for(const[n,i]of this._map)ne(i)&&i._attach(e.generateId(),e)}_attachChild(t,e){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");const{id:n,parentKey:i,opId:o}=t,s=i,r=Yt(t);if(void 0!==this._pool.getNode(n))return{modified:!1};if(2===e){const t=this.unacknowledgedSet.get(s);if(t===o)return this.unacknowledgedSet.delete(s),{modified:!1};if(void 0!==t)return{modified:!1}}else 1===e&&this.unacknowledgedSet.delete(s);const a=this._map.get(s);let c;if(a){const t=p(this._id);c=a._toOps(t,s),a._detach()}else c=[{type:5,id:n}];return r._setParentLink(this,s),r._attach(n,this._pool),this._map.set(s,r),this.invalidate(),{modified:{node:this,type:"LiveMap",updates:{[s]:{type:"update"}}},reverse:c}}_detach(){super._detach();for(const t of this._map.values())t._detach()}_detachChild(t){const e=p(this._id),n=p(t._parentKey),i=t._toOps(e,n,this._pool);for(const[o,s]of this._map)s===t&&(this._map.delete(o),this.invalidate());t._detach();return{modified:{node:this,type:"LiveMap",updates:{[n]:{type:"delete"}}},reverse:i}}_serialize(){if("HasParent"!==this.parent.type)throw new Error("Cannot serialize LiveMap if parent is missing");return{type:2,parentId:p(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get(t){const e=this._map.get(t);if(void 0!==e)return se(e)}set(t,e){this._pool?.assertStorageIsWritable();const n=this._map.get(t);n&&n._detach();const i=re(e);if(i._setParentLink(this,t),this._map.set(t,i),this.invalidate(),this._pool&&this._id){const e=this._pool.generateId();i._attach(e,this._pool);const o=new Map;o.set(this._id,{node:this,type:"LiveMap",updates:{[t]:{type:"update"}}});const s=i._toOps(this._id,t,this._pool);this.unacknowledgedSet.set(t,p(s[0].opId)),this._pool.dispatch(i._toOps(this._id,t,this._pool),n?n._toOps(this._id,t):[{type:5,id:e}],o)}}get size(){return this._map.size}has(t){return this._map.has(t)}delete(t){this._pool?.assertStorageIsWritable();const e=this._map.get(t);if(void 0===e)return!1;if(e._detach(),this._map.delete(t),this.invalidate(),this._pool&&e._id){const n=p(this._id),i=new Map;i.set(n,{node:this,type:"LiveMap",updates:{[t]:{type:"delete"}}}),this._pool.dispatch([{type:5,id:e._id,opId:this._pool.generateOpId()}],e._toOps(n,t),i)}return!0}entries(){const t=this._map.entries();return{[Symbol.iterator](){return this},next(){const e=t.next();if(e.done)return{done:!0,value:void 0};return{value:[e.value[0],se(e.value[1])]}}}}[Symbol.iterator](){return this.entries()}keys(){return this._map.keys()}values(){const t=this._map.values();return{[Symbol.iterator](){return this},next(){const e=t.next();if(e.done)return{done:!0,value:void 0};return{value:se(e.value)}}}}forEach(t){for(const e of this)t(e[1],e[0],this)}_toTreeNode(t){return{type:"LiveMap",id:this._id??Rt(),key:t,payload:Array.from(this._map.entries()).map((([t,e])=>e.toTreeNode(t)))}}toImmutable(){return super.toImmutable()}_toImmutable(){const t=new Map;for(const[e,n]of this._map)t.set(e,n.toImmutable());return Vt(t)}clone(){return new t(Array.from(this._map).map((([t,e])=>[t,e.clone()])))}},Bt=class t extends Lt{static _buildRootAndParentToChildren(t){const e=new Map;let n=null;for(const[i,o]of t)if(Ut(o))n=[i,o];else{const t=[i,o],n=e.get(o.parentId);void 0!==n?n.push(t):e.set(o.parentId,[t])}if(null===n)throw new Error("Root can't be null");return[n,e]}static _fromItems(e,n){const[i,o]=t._buildRootAndParentToChildren(e);return t._deserialize(i,o,n)}constructor(t={}){super(),this._propToLastUpdate=new Map;const e=x(t);for(const n of Object.keys(e)){const t=e[n];ne(t)&&t._setParentLink(this,n)}this._map=new Map(Object.entries(e))}_toOps(t,e,n){if(void 0===this._id)throw new Error("Cannot serialize item is not attached");const i=n?.generateOpId(),o=[],s={type:4,id:this._id,opId:i,parentId:t,parentKey:e,data:{}};o.push(s);for(const[r,a]of this._map)ne(a)?o.push(...a._toOps(this._id,r,n)):s.data[r]=a;return o}static _deserialize([e,n],i,o){const s=new t(n.data);return s._attach(e,o),this._deserializeChildren(s,i,o)}static _deserializeChildren(t,e,n){const i=e.get(p(t._id));if(void 0===i)return t;for(const[o,s]of i){const i=te([o,s],e,n);ee(i)&&i._setParentLink(t,s.parentKey),t._map.set(s.parentKey,i),t.invalidate()}return t}_attach(t,e){super._attach(t,e);for(const[n,i]of this._map)ne(i)&&i._attach(e.generateId(),e)}_attachChild(t,e){if(void 0===this._pool)throw new Error("Can't attach child if managed pool is not present");const{id:n,opId:i,parentKey:o}=t,s=Xt(t);if(void 0!==this._pool.getNode(n))return this._propToLastUpdate.get(o)===i&&this._propToLastUpdate.delete(o),{modified:!1};if(0===e)this._propToLastUpdate.set(o,p(i));else if(void 0!==this._propToLastUpdate.get(o))return this._propToLastUpdate.get(o)===i?(this._propToLastUpdate.delete(o),{modified:!1}):{modified:!1};const r=p(this._id),a=this._map.get(o);let c;return ne(a)?(c=a._toOps(r,o),a._detach()):c=void 0===a?[{type:6,id:r,key:o}]:[{type:3,id:r,data:{[o]:a}}],this._map.set(o,s),this.invalidate(),ee(s)&&(s._setParentLink(this,o),s._attach(n,this._pool)),{reverse:c,modified:{node:this,type:"LiveObject",updates:{[o]:{type:"update"}}}}}_detachChild(t){if(t){const e=p(this._id),n=p(t._parentKey),i=t._toOps(e,n,this._pool);for(const[o,s]of this._map)s===t&&(this._map.delete(o),this.invalidate());t._detach();return{modified:{node:this,type:"LiveObject",updates:{[n]:{type:"delete"}}},reverse:i}}return{modified:!1}}_detach(){super._detach();for(const t of this._map.values())ne(t)&&t._detach()}_apply(t,e){return 3===t.type?this._applyUpdate(t,e):6===t.type?this._applyDeleteObjectKey(t,e):super._apply(t,e)}_serialize(){const t={};for(const[e,n]of this._map)ne(n)||(t[e]=n);return"HasParent"===this.parent.type&&this.parent.node._id?{type:0,parentId:this.parent.node._id,parentKey:this.parent.key,data:t}:{type:0,data:t}}_applyUpdate(t,e){let n=!1;const i=p(this._id),o=[],s={type:3,id:i,data:{}};for(const a in t.data){const t=this._map.get(a);ne(t)?(o.push(...t._toOps(i,a)),t._detach()):void 0!==t?s.data[a]=t:void 0===t&&o.push({type:6,id:i,key:a})}const r={};for(const a in t.data){const i=t.data[a];if(void 0===i)continue;if(e)this._propToLastUpdate.set(a,p(t.opId));else{if(void 0!==this._propToLastUpdate.get(a)){if(this._propToLastUpdate.get(a)===t.opId){this._propToLastUpdate.delete(a);continue}continue}n=!0}const o=this._map.get(a);ne(o)&&o._detach(),n=!0,r[a]={type:"update"},this._map.set(a,i),this.invalidate()}return 0!==Object.keys(s.data).length&&o.unshift(s),n?{modified:{node:this,type:"LiveObject",updates:r},reverse:o}:{modified:!1}}_applyDeleteObjectKey(t,e){const n=t.key;if(!1===this._map.has(n))return{modified:!1};if(!e&&void 0!==this._propToLastUpdate.get(n))return{modified:!1};const i=this._map.get(n),o=p(this._id);let s=[];return ne(i)?(s=i._toOps(o,t.key),i._detach()):void 0!==i&&(s=[{type:3,id:o,data:{[n]:i}}]),this._map.delete(n),this.invalidate(),{modified:{node:this,type:"LiveObject",updates:{[t.key]:{type:"delete"}}},reverse:s}}toObject(){return Object.fromEntries(this._map)}set(t,e){this._pool?.assertStorageIsWritable(),this.update({[t]:e})}get(t){return this._map.get(t)}delete(t){this._pool?.assertStorageIsWritable();const e=t,n=this._map.get(e);if(void 0===n)return;if(void 0===this._pool||void 0===this._id)return ne(n)&&n._detach(),this._map.delete(e),void this.invalidate();let i;ne(n)?(n._detach(),i=n._toOps(this._id,e)):i=[{type:3,data:{[e]:n},id:this._id}],this._map.delete(e),this.invalidate();const o=new Map;o.set(this._id,{node:this,type:"LiveObject",updates:{[t]:{type:"delete"}}}),this._pool.dispatch([{type:6,key:e,id:this._id,opId:this._pool.generateOpId()}],i,o)}update(t){if(this._pool?.assertStorageIsWritable(),void 0===this._pool||void 0===this._id){for(const e in t){const n=t[e];if(void 0===n)continue;const i=this._map.get(e);ne(i)&&i._detach(),ne(n)&&n._setParentLink(this,e),this._map.set(e,n),this.invalidate()}return}const e=[],n=[],i=this._pool.generateOpId(),o={},s={id:this._id,type:3,data:{}},r={};for(const c in t){const a=t[c];if(void 0===a)continue;const d=this._map.get(c);if(ne(d)?(n.push(...d._toOps(this._id,c)),d._detach()):void 0===d?n.push({type:6,id:this._id,key:c}):s.data[c]=d,ne(a)){a._setParentLink(this,c),a._attach(this._pool.generateId(),this._pool);const t=a._toOps(this._id,c,this._pool),n=t.find((t=>t.parentId===this._id));n&&this._propToLastUpdate.set(c,p(n.opId)),e.push(...t)}else o[c]=a,this._propToLastUpdate.set(c,i);this._map.set(c,a),this.invalidate(),r[c]={type:"update"}}0!==Object.keys(s.data).length&&n.unshift(s),0!==Object.keys(o).length&&e.unshift({opId:i,id:this._id,type:3,data:o});const a=new Map;a.set(this._id,{node:this,type:"LiveObject",updates:r}),this._pool.dispatch(e,n,a)}toImmutable(){return super.toImmutable()}toTreeNode(t){return super.toTreeNode(t)}_toTreeNode(t){const e=this._id??Rt();return{type:"LiveObject",id:e,key:t,payload:Array.from(this._map.entries()).map((([t,n])=>ne(n)?n.toTreeNode(t):{type:"Json",id:`${e}:${t}`,key:t,payload:n}))}}_toImmutable(){const t={};for(const[e,n]of this._map)t[e]=ee(n)?n.toImmutable():n;return t}clone(){return new t(Object.fromEntries(Array.from(this._map).map((([t,e])=>[t,ee(e)?e.clone():P(e)]))))}};function Yt(t){return re(Xt(t))}function Xt(t){switch(t.type){case 8:return t.data;case 4:return new Bt(t.data);case 7:return new Gt;case 2:return new Mt([]);default:return l(0,"Unknown creation Op")}}function Zt(t,e){return t===e||"HasParent"===t.parent.type&&Zt(t.parent.node,e)}function Qt([t,e],n,i){switch(e.type){case 0:return Bt._deserialize([t,e],n,i);case 1:return Mt._deserialize([t,e],n,i);case 2:return Gt._deserialize([t,e],n,i);case 3:return jt._deserialize([t,e],n,i);default:throw new Error("Unexpected CRDT type")}}function te([t,e],n,i){switch(e.type){case 0:return Bt._deserialize([t,e],n,i);case 1:return Mt._deserialize([t,e],n,i);case 2:return Gt._deserialize([t,e],n,i);case 3:return e.data;default:throw new Error("Unexpected CRDT type")}}function ee(t){return ie(t)||function(t){return t instanceof Gt}(t)||oe(t)}function ne(t){return ee(t)||function(t){return t instanceof jt}(t)}function ie(t){return t instanceof Mt}function oe(t){return t instanceof Bt}function se(t){return t instanceof jt?t.data:t instanceof Mt||t instanceof Gt||t instanceof Bt?t:l(0,"Unknown AbstractCrdt")}function re(t){return t instanceof Bt||t instanceof Gt||t instanceof Mt?t:new jt(t)}function ae(t,e){return void 0===t?e:"LiveObject"===t.type&&"LiveObject"===e.type?function(t,e){const n=t.updates;for(const[i,o]of O(e.updates))n[i]=o;return{...e,updates:n}}(t,e):"LiveMap"===t.type&&"LiveMap"===e.type?function(t,e){const n=t.updates;for(const[i,o]of O(e.updates))n[i]=o;return{...e,updates:n}}(t,e):"LiveList"===t.type&&"LiveList"===e.type?function(t,e){const n=t.updates;return{...e,updates:n.concat(e.updates)}}(t,e):e}function ce(t){return Array.isArray(t)}function de(t){return!function(t){return null===t||"string"===typeof t||"number"===typeof t||"boolean"===typeof t}(t)&&!ce(t)}var ue=/^[a-zA-Z_][a-zA-Z0-9_]*$/;var he=t=>{const e=[];return t.forEach((([t,n])=>{e.push({key:t,operator:":",value:n})})),e},le=t=>{const e=[];return t.forEach((([t,n])=>{"startsWith"in n&&"string"===typeof n.startsWith&&e.push({key:t,operator:"^",value:n.startsWith})})),e},pe=t=>"string"===typeof t||"number"===typeof t||"boolean"===typeof t,fe=t=>"object"===typeof t&&null!==t&&"startsWith"in t,me=(t,e,n)=>`${t}${e}${n}`,ye=(t,e)=>e?`${t}[${JSON.stringify(e)}]`:t,_e=t=>{if("string"===typeof t){if(ge(t))throw new Error("Value cannot be empty");return JSON.stringify(t)}return t.toString()},ge=t=>!t||""===t.toString().trim(),be=(t=>(t[t.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",t[t.BROADCAST_EVENT=103]="BROADCAST_EVENT",t[t.FETCH_STORAGE=200]="FETCH_STORAGE",t[t.UPDATE_STORAGE=201]="UPDATE_STORAGE",t[t.FETCH_YDOC=300]="FETCH_YDOC",t[t.UPDATE_YDOC=301]="UPDATE_YDOC",t))(be||{});function ve(t,e){let n=!1;const i={...t};return Object.keys(e).forEach((t=>{const o=t,s=e[o];i[o]!==s&&(void 0===s?delete i[o]:i[o]=s,n=!0)})),n?i:t}var we=class{constructor(){this._ev=f()}get didInvalidate(){return this._ev.observable}invalidate(){void 0!==this._cache&&(this._cache=void 0,this._ev.notify())}get current(){return this._cache??(this._cache=this._toImmutable())}};var Ie=class extends we{constructor(){super(),this._connections=new Map,this._presences=new Map,this._users=new Map}connectionIds(){return this._connections.keys()}_toImmutable(){return N(Array.from(this._presences.keys()).map((t=>this.getUser(Number(t)))))}clearOthers(){this._connections=new Map,this._presences=new Map,this._users=new Map,this.invalidate()}_getUser(t){const e=this._connections.get(t),n=this._presences.get(t);if(void 0!==e&&void 0!==n)return function(t,e){const{connectionId:n,id:i,info:o}=t,s=et(t.scopes);return Vt(x({connectionId:n,id:i,info:o,canWrite:s,canComment:nt(t.scopes),isReadOnly:!s,presence:e}))}(e,n)}getUser(t){const e=this._users.get(t);if(e)return e;const n=this._getUser(t);return n?(this._users.set(t,n),n):void 0}_invalidateUser(t){this._users.has(t)&&this._users.delete(t),this.invalidate()}setConnection(t,e,n,i){this._connections.set(t,Vt({connectionId:t,id:e,info:n,scopes:i})),this._presences.has(t)&&this._invalidateUser(t)}removeConnection(t){this._connections.delete(t),this._presences.delete(t),this._invalidateUser(t)}setOther(t,e){this._presences.set(t,Vt(x(e))),this._connections.has(t)&&this._invalidateUser(t)}patchOther(t,e){const n=this._presences.get(t);if(void 0===n)return;const i=ve(n,e);n!==i&&(this._presences.set(t,Vt(i)),this._invalidateUser(t))}},ke=class extends we{constructor(t){super(),this._data=Vt(x(t))}_toImmutable(){return this._data}patch(t){const e=this._data,n=ve(e,t);e!==n&&(this._data=Vt(n),this.invalidate())}},Ee=class extends we{constructor(t){super(),this._value=Vt(t)}_toImmutable(){return this._value}set(t){this._value=Vt(t),this.invalidate()}},Se=class extends we{constructor(...t){super();const e=t.pop(),n=t;this._refs=n,this._refs.forEach((t=>{t.didInvalidate.subscribe((()=>this.invalidate()))})),this._transform=e}_toImmutable(){return this._transform(...this._refs.map((t=>t.current)))}},Te=1047552;function Ae(t,e){return{type:"User",id:`${e.connectionId}`,key:t,payload:{connectionId:e.connectionId,id:e.id,info:e.info,presence:e.presence,isReadOnly:!e.canWrite}}}var Oe=class extends Error{constructor(t,e,n){super(t),this.message=t,this.status=e,this.details=n}};function Ce(t,e,n){async function i(i,o,s){const r=await e();return n(t,i,r,s,o)}async function o(t,e,n){const o=await i(t,n,e);if(!o.ok&&o.status>=400&&o.status<600){let t;try{const e=await o.json();t=new Oe(e.message,o.status,e)}catch{t=new Oe(o.statusText,o.status)}throw t}let s;try{s=await o.json()}catch{s={}}return s}return{getThreads:async function(t){let e;t?.query&&(e=function(t){let e=[];const n=Object.entries(t),i=[],o=[],s=[];return n.forEach((([t,e])=>{if(!ue.test(t))throw new Error("Key must only contain letters, numbers, _");pe(e)?i.push([t,e]):fe(e)?o.push([t,e]):"object"!==typeof e||"startsWith"in e||s.push([t,e])})),e=[...he(i),...le(o)],s.forEach((([t,n])=>{const i=Object.entries(n),o=[],s=[];i.forEach((([e,n])=>{if(ge(e))throw new Error("Key cannot be empty");pe(n)?o.push([ye(t,e),n]):fe(n)&&s.push([ye(t,e),n])})),e=[...e,...he(o),...le(s)]})),e.map((({key:t,operator:e,value:n})=>me(t,e,_e(n)))).join(" AND ")}(t.query));const n=await i("/threads",{since:t?.since?.toISOString(),query:e},{headers:{"Content-Type":"application/json"}});if(n.ok){const t=await n.json();return{threads:t.data.map((t=>ft(t))),inboxNotifications:t.inboxNotifications.map((t=>mt(t))),deletedThreads:t.deletedThreads.map((t=>yt(t))),deletedInboxNotifications:t.deletedInboxNotifications.map((t=>_t(t))),meta:{requestedAt:new Date(t.meta.requestedAt)}}}if(404===n.status)return{threads:[],inboxNotifications:[],deletedThreads:[],deletedInboxNotifications:[],meta:{requestedAt:new Date}};throw new Error("There was an error while getting threads.")},getThread:async function({threadId:t}){const e=await i(`/thread-with-notification/${t}`);if(e.ok){const t=await e.json();return{thread:ft(t.thread),inboxNotification:t.inboxNotification?mt(t.inboxNotification):void 0}}if(404!==e.status)throw new Error(`There was an error while getting thread ${t}.`)},createThread:async function({metadata:t,body:e,commentId:n,threadId:i}){return ft(await o("/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,comment:{id:n,body:e},metadata:t})}))},deleteThread:async function({threadId:t}){await o(`/threads/${encodeURIComponent(t)}`,{method:"DELETE"})},editThreadMetadata:async function({metadata:t,threadId:e}){return await o(`/threads/${encodeURIComponent(e)}/metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})},createComment:async function({threadId:t,commentId:e,body:n}){return pt(await o(`/threads/${encodeURIComponent(t)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,body:n})}))},editComment:async function({threadId:t,commentId:e,body:n}){return pt(await o(`/threads/${encodeURIComponent(t)}/comments/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:n})}))},deleteComment:async function({threadId:t,commentId:e}){await o(`/threads/${encodeURIComponent(t)}/comments/${encodeURIComponent(e)}`,{method:"DELETE"})},addReaction:async function({threadId:t,commentId:e,emoji:n}){const i=await o(`/threads/${encodeURIComponent(t)}/comments/${encodeURIComponent(e)}/reactions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emoji:n})});return s=i,{...s,createdAt:new Date(s.createdAt)};var s},removeReaction:async function({threadId:t,commentId:e,emoji:n}){await o(`/threads/${encodeURIComponent(t)}/comments/${encodeURIComponent(e)}/reactions/${encodeURIComponent(n)}`,{method:"DELETE"})}}}var Pe=50;function Ne(t,e){const n=t.initialPresence,i=t.initialStorage,[o,s]=function(){const t="undefined"!==typeof document?document:void 0,e={current:null};function n(){e.current="hidden"===t?.visibilityState?e.current??Date.now():null}return t?.addEventListener("visibilitychange",n),[e,()=>{t?.removeEventListener("visibilitychange",n)}]}(),r={...e.delegates,canZombie:()=>void 0!==e.backgroundKeepAliveTimeout&&null!==o.current&&Date.now()>o.current+e.backgroundKeepAliveTimeout&&"synchronizing"!==Z()},a=new tt(r,e.enableDebugLogging),c={buffer:{flushTimerID:void 0,lastFlushedAt:0,presenceUpdates:{type:"full",data:n},messages:[],storageOperations:[]},staticSessionInfo:new Ee(null),dynamicSessionInfo:new Ee(null),myPresence:new ke(n),others:new Ie,initialStorage:i,idFactory:null,clock:0,opClock:0,nodes:new Map,root:void 0,undoStack:[],redoStack:[],pausedHistory:null,activeBatch:null,unacknowledgedOps:new Map,opStackTraces:void 0},d=t=>t(),u=e.unstable_batchedUpdates??d;let h,l;let m=!1;a.events.onMessage.subscribe((function(t){if("string"!==typeof t.data)return;const e=function(t){const e=C(t);return void 0===e?null:ce(e)?N(e.map((t=>W(t)))):N([W(e)])}(t.data);if(null===e||0===e.length)return;const n={storageUpdates:new Map,others:[]};u((()=>{for(const t of e)switch(t.type){case 101:{const e=z(t);e&&n.others.push(e);break}case 100:{const e=R(t);e&&n.others.push(e);break}case 103:{const e=c.others.current;_.customEvent.notify({connectionId:t.actor,user:t.actor<0?null:e.find((e=>e.connectionId===t.actor))??null,event:t.event});break}case 102:{const e=j(t);e&&n.others.push(e);break}case 300:_.ydoc.notify(t);break;case 104:n.others.push(K(t,d));break;case 200:G(t);break;case 201:{const e=L(t.ops,!1);for(const[t,i]of e.updates.storageUpdates)n.storageUpdates.set(t,ae(n.storageUpdates.get(t),i));break}case 299:I("Storage mutation rejection error",t.reason);break;case 400:case 407:case 401:case 405:case 406:case 402:case 403:case 404:_.comments.notify(t)}x(n,d)}))})),a.events.statusDidChange.subscribe((function(t){const e=a.authValue;if(null!==e){const t=en(e);if(t!==h)if(h=t,"secret"===e.type){const t=e.token.parsed;c.staticSessionInfo.set({userId:"sec-legacy"===t.k?t.id:t.uid,userInfo:"sec-legacy"===t.k?t.info:t.ui})}else c.staticSessionInfo.set({userId:void 0,userInfo:void 0})}u((()=>{_.status.notify(t),E(d)}))})),a.events.statusDidChange.subscribe((function(t){"reconnecting"===t?l=setTimeout((()=>{u((()=>{_.lostConnection.notify("lost"),m=!0,c.others.clearOthers(),x({others:[{type:"reset"}]},d)}))}),e.lostConnectionTimeout):(clearTimeout(l),m&&(u("disconnected"===t?()=>{_.lostConnection.notify("failed")}:()=>{_.lostConnection.notify("restored")}),m=!1))})),a.events.didConnect.subscribe((function(){c.buffer.presenceUpdates={type:"full",data:{...c.myPresence.current}},null!==q&&Y({flush:!1}),F()})),a.events.didDisconnect.subscribe((function(){clearTimeout(c.buffer.flushTimerID)})),a.events.onLiveblocksError.subscribe((t=>{u((()=>{_.error.notify(t)}))}));const y={roomId:e.roomId,getNode:t=>c.nodes.get(t),addNode:(t,e)=>{c.nodes.set(t,e)},deleteNode:t=>{c.nodes.delete(t)},generateId:()=>`${D()}:${c.clock++}`,generateOpId:()=>`${D()}:${c.opClock++}`,dispatch(t,e,n){const i=c.activeBatch;if(i){for(const e of t)i.ops.push(e);for(const[t,e]of n)i.updates.storageUpdates.set(t,ae(i.updates.storageUpdates.get(t),e));i.reverseOps.unshift(...e)}else u((()=>{O(e,d),c.redoStack.length=0,J(t),x({storageUpdates:n},d)}))},assertStorageIsWritable:()=>{const t=c.dynamicSessionInfo.current?.scopes;if(void 0===t)return;if(!et(t))throw new Error("Cannot write to storage with a read only user, please ensure the user has write permissions")}},_={status:f(),lostConnection:f(),customEvent:f(),self:f(),myPresence:f(),others:f(),error:f(),storage:f(),history:f(),storageDidLoad:f(),storageStatus:f(),ydoc:f(),comments:f()};async function b(t,n,i,o,s){const r=gt(e.baseUrl,`/v2/c/rooms/${encodeURIComponent(t)}${n}`,s),a=e.polyfills?.fetch||fetch;return await a(r,{...o,headers:{...o?.headers,Authorization:`Bearer ${en(i)}`}})}function v(t){const n=JSON.stringify(t),i=c.dynamicSessionInfo.current?.nonce;if(e.unstable_fallbackToHTTP&&i){if((new TextEncoder).encode(n).length>Te)return async function(t,n){if(!a.authValue)throw new Error("Not authorized");return b(e.roomId,t,a.authValue,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}("/send-message",{nonce:i,messages:t}).then((t=>{t.ok||403!==t.status||a.reconnect()})),void g("Message was too large for websockets and sent over HTTP instead")}a.send(n)}const w=new Se(c.staticSessionInfo,c.dynamicSessionInfo,c.myPresence,((t,e,n)=>{if(null===t||null===e)return null;{const i=et(e.scopes);return{connectionId:e.actor,id:t.userId,info:t.userInfo,presence:n,canWrite:i,canComment:nt(e.scopes)}}}));let k;function E(t){const e=w.current;null!==e&&e!==k&&(t((()=>{_.self.notify(e)})),k=e)}const S=new Se(w,(t=>null!==t?Ae("Me",t):null));function T(t,e){if(0===t.items.length)throw new Error("Internal error: cannot load storage without items");void 0!==c.root?function(t,e){if(void 0===c.root)return;const n=new Map;for(const[o,s]of c.nodes)n.set(o,s._serialize());const i=function(t,e){const n=[];return t.forEach(((t,i)=>{e.get(i)||n.push({type:5,id:i})})),e.forEach(((e,i)=>{const o=t.get(i);if(o)0===e.type&&(0===o.type&&JSON.stringify(e.data)===JSON.stringify(o.data)||n.push({type:3,id:i,data:e.data})),e.parentKey!==o.parentKey&&n.push({type:1,id:i,parentKey:p(e.parentKey,"Parent key must not be missing")});else switch(e.type){case 3:n.push({type:8,id:i,parentId:e.parentId,parentKey:e.parentKey,data:e.data});break;case 1:n.push({type:2,id:i,parentId:e.parentId,parentKey:e.parentKey});break;case 0:if(void 0===e.parentId||void 0===e.parentKey)throw new Error("Internal error. Cannot serialize storage root into an operation");n.push({type:4,id:i,parentId:e.parentId,parentKey:e.parentKey,data:e.data});break;case 2:n.push({type:7,id:i,parentId:e.parentId,parentKey:e.parentKey})}})),n}(n,new Map(t));x(L(i,!1).updates,e)}(t.items,e):c.root=Bt._fromItems(t.items,y);const n=w.current?.canWrite??!0,i=c.undoStack.length;for(const s in c.initialStorage)void 0===c.root.get(s)&&(n?c.root.set(s,void 0===(o=c.initialStorage[s])?void 0:ee(o)?o.clone():P(o)):g(`Attempted to populate missing storage key '${s}', but current user has no write access`));var o;c.undoStack.length=i}function A(t,e){c.undoStack.length>=50&&c.undoStack.shift(),c.undoStack.push(t),H(e)}function O(t,e){null!==c.pausedHistory?c.pausedHistory.unshift(...t):A(t,e)}function x(t,e){const n=t.storageUpdates,i=t.others;e((()=>{if(void 0!==i&&i.length>0){const t=c.others.current;for(const e of i)_.others.notify({...e,others:t})}if(t.presence&&(E(d),_.myPresence.notify(c.myPresence.current)),void 0!==n&&n.size>0){const t=Array.from(n.values());_.storage.notify(t)}it()}))}function D(){const t=c.dynamicSessionInfo.current;if(t)return t.actor;throw new Error("Internal. Tried to get connection id but connection was never open")}function L(t,e){const n={reverse:[],storageUpdates:new Map,presence:!1},i=new Set,o=t.map((t=>"presence"===t.type||t.opId?t:{...t,opId:y.generateOpId()}));for(const s of o)if("presence"===s.type){const t={type:"presence",data:{}};for(const e in s.data)t.data[e]=c.myPresence.current[e];if(c.myPresence.patch(s.data),null===c.buffer.presenceUpdates)c.buffer.presenceUpdates={type:"partial",data:s.data};else for(const e in s.data)c.buffer.presenceUpdates.data[e]=s.data[e];n.reverse.unshift(t),n.presence=!0}else{let t;if(e)t=0;else{const e=p(s.opId);0;t=c.unacknowledgedOps.delete(e)?2:1}const o=U(s,t);if(o.modified){const t=o.modified.node._id;t&&i.has(t)||(n.storageUpdates.set(p(o.modified.node._id),ae(n.storageUpdates.get(p(o.modified.node._id)),o.modified)),n.reverse.unshift(...o.reverse)),2!==s.type&&7!==s.type&&4!==s.type||i.add(p(s.id))}}return{ops:o,reverse:n.reverse,updates:{storageUpdates:n.storageUpdates,presence:n.presence}}}function U(t,e){if(function(t){return 5===t.type&&"ACK"===t.id}(t))return{modified:!1};switch(t.type){case 6:case 3:case 5:{const n=c.nodes.get(t.id);return void 0===n?{modified:!1}:n._apply(t,0===e)}case 1:{const n=c.nodes.get(t.id);return void 0===n?{modified:!1}:"HasParent"===n.parent.type&&ie(n.parent.node)?n.parent.node._setChildKey(Nt(t.parentKey),n,e):{modified:!1}}case 4:case 2:case 7:case 8:{if(void 0===t.parentId)return{modified:!1};const n=c.nodes.get(t.parentId);return void 0===n?{modified:!1}:n._attachChild(t,e)}}}function R(t){if(void 0!==t.targetActor){const e=c.others.getUser(t.actor);c.others.setOther(t.actor,t.data);const n=c.others.getUser(t.actor);if(void 0===e&&void 0!==n)return{type:"enter",user:n}}else c.others.patchOther(t.actor,t.data);const e=c.others.getUser(t.actor);return e?{type:"update",updates:t.data,user:e}:void 0}function j(t){const e=c.others.getUser(t.actor);return e?(c.others.removeConnection(t.actor),{type:"leave",user:e}):null}function K(t,e){c.dynamicSessionInfo.set({actor:t.actor,nonce:t.nonce,scopes:t.scopes}),c.idFactory=function(t){let e=0;return()=>`${t}:${e++}`}(t.actor),E(e);for(const n of c.others.connectionIds()){void 0===t.users[n]&&c.others.removeConnection(n)}for(const n in t.users){const e=t.users[n],i=Number(n);c.others.setConnection(i,e.id,e.info,e.scopes)}return{type:"reset"}}function M(){return c.undoStack.length>0}function $(){return c.redoStack.length>0}function H(t){t((()=>{_.history.notify({canUndo:M(),canRedo:$()})}))}function z(t){c.others.setConnection(t.actor,t.id,t.info,t.scopes),c.buffer.messages.push({type:100,data:c.myPresence.current,targetActor:t.actor}),F();const e=c.others.getUser(t.actor);return e?{type:"enter",user:e}:void 0}function W(t){return de(t)?t:null}function F(){const t=c.buffer.storageOperations;if(t.length>0){for(const e of t)c.unacknowledgedOps.set(p(e.opId),e);it()}if("connected"!==a.getStatus())return void(c.buffer.storageOperations=[]);const n=Date.now(),i=n-c.buffer.lastFlushedAt;if(i>=e.throttleDelay){const t=function(){const t=[];c.buffer.presenceUpdates&&t.push("full"===c.buffer.presenceUpdates.type?{type:100,targetActor:-1,data:c.buffer.presenceUpdates.data}:{type:100,data:c.buffer.presenceUpdates.data});for(const e of c.buffer.messages)t.push(e);c.buffer.storageOperations.length>0&&t.push({type:201,ops:c.buffer.storageOperations});return t}();if(0===t.length)return;v(t),c.buffer={flushTimerID:void 0,lastFlushedAt:n,messages:[],storageOperations:[],presenceUpdates:null}}else clearTimeout(c.buffer.flushTimerID),c.buffer.flushTimerID=setTimeout(F,e.throttleDelay-i)}function J(t){const{storageOperations:e}=c.buffer;for(const n of t)e.push(n);F()}let q=null,V=null;function G(t){const e=new Map(c.unacknowledgedOps);T(t,d),function(t,e){if(0===t.size)return;const n=[],i=L(Array.from(t.values()),!0);n.push({type:201,ops:i.ops}),x(i.updates,e),v(n)}(e,d),V?.(),it(),_.storageDidLoad.notify()}async function B(){if(!a.authValue)return;const t=await async function(t,e){return b(e,"/storage",t,{method:"GET",headers:{"Content-Type":"application/json"}})}(a.authValue,e.roomId);G({type:200,items:await t.json()})}function Y(t){const n=c.buffer.messages;e.unstable_streamData?B():n.some((t=>200===t.type))||n.push({type:200}),t.flush&&F()}function X(){return null===q&&(Y({flush:!0}),q=new Promise((t=>{V=t})),it()),q}function Z(){return void 0===c.root?null===q?"not-loaded":"loading":0===c.unacknowledgedOps.size?"synchronized":"synchronizing"}let Q=Z();function it(){const t=Z();Q!==t&&(Q=t,_.storageStatus.notify(t))}const ot=new Se(c.others,(t=>t.map(((t,e)=>Ae(`Other ${e}`,t))))),st={status:_.status.observable,lostConnection:_.lostConnection.observable,customEvent:_.customEvent.observable,others:_.others.observable,self:_.self.observable,myPresence:_.myPresence.observable,error:_.error.observable,storage:_.storage.observable,history:_.history.observable,storageDidLoad:_.storageDidLoad.observable,storageStatus:_.storageStatus.observable,ydoc:_.ydoc.observable,comments:_.comments.observable},at=Ce(e.roomId,r.authenticate,b);async function ct(t,n){const i=await r.authenticate(),o=await b(e.roomId,t,i,n);if(!o.ok&&o.status>=400&&o.status<600){let t;try{const e=await o.json();t=new on(e.message,o.status,e)}catch{t=new on(o.statusText,o.status)}throw t}let s;try{s=await o.json()}catch{s={}}return s}const dt=new ut((async t=>{const e=t.flat();return await async function(t){await ct("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:t})})}(e),e}),{delay:Pe});return Object.defineProperty({[rt]:{get presenceBuffer(){return P(c.buffer.presenceUpdates?.data??null)},get undoStack(){return P(c.undoStack)},get nodeCount(){return c.nodes.size},reportTextEditor:async function(t,n){const i=await r.authenticate();return b(e.roomId,"/text-metadata",i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:t,rootKey:n})})},createTextMention:async function(t,n){if(!a.authValue)throw new Error("Not authorized");return b(e.roomId,"/text-mentions",a.authValue,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,mentionId:n})})},deleteTextMention:async function(t){if(!a.authValue)throw new Error("Not authorized");return b(e.roomId,`/text-mentions/${t}`,a.authValue,{method:"DELETE"})},getSelf_forDevTools:()=>S.current,getOthers_forDevTools:()=>ot.current,simulate:{explicitClose:t=>a._privateSendMachineEvent({type:"EXPLICIT_SOCKET_CLOSE",event:t}),rawSend:t=>a.send(t)},comments:{...at},notifications:{getRoomNotificationSettings:function(){return ct("/notification-settings")},updateRoomNotificationSettings:function(t){return ct("/notification-settings",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})},markInboxNotificationAsRead:async function(t){await dt.get(t)}}},id:e.roomId,subscribe:xe(st),connect:()=>a.connect(),reconnect:()=>a.reconnect(),disconnect:()=>a.disconnect(),destroy:()=>{s(),a.destroy()},updatePresence:function(t,e){const n={};null===c.buffer.presenceUpdates&&(c.buffer.presenceUpdates={type:"partial",data:{}});for(const i in t){const e=t[i];void 0!==e&&(c.buffer.presenceUpdates.data[i]=e,n[i]=c.myPresence.current[i])}c.myPresence.patch(t),c.activeBatch?(e?.addToHistory&&c.activeBatch.reverseOps.unshift({type:"presence",data:n}),c.activeBatch.updates.presence=!0):(F(),u((()=>{e?.addToHistory&&O([{type:"presence",data:n}],d),x({presence:!0},d)})))},updateYDoc:function(t,e){const n={type:301,update:t,guid:e};c.buffer.messages.push(n),_.ydoc.notify(n),F()},broadcastEvent:function(t,e={shouldQueueEventIfNotReady:!1}){("connected"===a.getStatus()||e.shouldQueueEventIfNotReady)&&(c.buffer.messages.push({type:103,event:t}),F())},batch:function(t){if(c.activeBatch)return t();let e;return u((()=>{c.activeBatch={ops:[],updates:{storageUpdates:new Map,presence:!1,others:[]},reverseOps:[]};try{e=t()}finally{const t=c.activeBatch;c.activeBatch=null,t.reverseOps.length>0&&O(t.reverseOps,d),t.ops.length>0&&(c.redoStack.length=0),t.ops.length>0&&J(t.ops),x(t.updates,d),F()}})),e},history:{undo:function(){if(c.activeBatch)throw new Error("undo is not allowed during a batch");const t=c.undoStack.pop();if(void 0===t)return;c.pausedHistory=null;const e=L(t,!0);u((()=>{x(e.updates,d),c.redoStack.push(e.reverse),H(d)}));for(const n of e.ops)"presence"!==n.type&&c.buffer.storageOperations.push(n);F()},redo:function(){if(c.activeBatch)throw new Error("redo is not allowed during a batch");const t=c.redoStack.pop();if(void 0===t)return;c.pausedHistory=null;const e=L(t,!0);u((()=>{x(e.updates,d),c.undoStack.push(e.reverse),H(d)}));for(const n of e.ops)"presence"!==n.type&&c.buffer.storageOperations.push(n);F()},canUndo:M,canRedo:$,clear:function(){c.undoStack.length=0,c.redoStack.length=0},pause:function(){null===c.pausedHistory&&(c.pausedHistory=[])},resume:function(){const t=c.pausedHistory;c.pausedHistory=null,null!==t&&t.length>0&&A(t,u)}},fetchYDoc:function(t,e){c.buffer.messages.find((n=>300===n.type&&n.vector===t&&n.guid===e))||c.buffer.messages.push({type:300,vector:t,guid:e}),F()},getStorage:async function(){return void 0!==c.root?Promise.resolve({root:c.root}):(await X(),{root:p(c.root)})},getStorageSnapshot:function(){const t=c.root;return void 0!==t?t:(X(),null)},getStorageStatus:Z,events:st,getStatus:()=>a.getStatus(),getSelf:()=>w.current,getPresence:()=>c.myPresence.current,getOthers:()=>c.others.current},rt,{enumerable:!1})}function xe(t){function e(e,n){return t.storage.subscribe((t=>{const i=t.filter((t=>Zt(t.node,e)));i.length>0&&n(i)}))}return function(n,i,o){if("string"===typeof n&&("my-presence"===(s=n)||"others"===s||"event"===s||"error"===s||"history"===s||"status"===s||"storage-status"===s||"lost-connection"===s||"connection"===s)){if("function"!==typeof i)throw new Error("Second argument must be a callback function");const e=i;switch(n){case"event":return t.customEvent.subscribe(e);case"my-presence":return t.myPresence.subscribe(e);case"others":{const n=e;return t.others.subscribe((t=>{const{others:e,...i}=t;return n(e,i)}))}case"error":return t.error.subscribe(e);case"status":return t.status.subscribe(e);case"lost-connection":return t.lostConnection.subscribe(e);case"history":return t.history.subscribe(e);case"storage-status":return t.storageStatus.subscribe(e);default:return l(0,`"${String(n)}" is not a valid event name`)}}var s;if(void 0===i||"function"===typeof n){if("function"===typeof n){const e=n;return t.storage.subscribe(e)}throw new Error("Please specify a listener callback")}if(ne(n)){const s=n;if(o?.isDeep){return e(s,i)}return function(e,n){return t.storage.subscribe((t=>{for(const i of t)i.node._id===e._id&&n(i.node)}))}(s,i)}throw new Error(`${String(n)} is not a value that can be subscribed to.`)}}function De(t,e){return async()=>e.getAuthValue({requestedScope:"room:read",roomId:t})}function Le(t,e,n){return i=>{const o=n??("undefined"===typeof WebSocket?void 0:WebSocket);if(void 0===o)throw new H("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");const r=new URL(e);if(r.protocol="http:"===r.protocol?"ws":"wss",r.pathname="/v7",r.searchParams.set("roomId",t),"secret"===i.type)r.searchParams.set("tok",i.token.raw);else{if("public"!==i.type)return l(0,"Unhandled case");r.searchParams.set("pubkey",i.publicApiKey)}return r.searchParams.set("version",s||"dev"),new o(r.toString())}}function Ue(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){const{[e]:n,...i}=t;return i}return t}function Re(t,e){return t.updatedAt&&e.updatedAt?t.updatedAt>e.updatedAt?1:t.updatedAt<e.updatedAt?-1:0:t.updatedAt||e.updatedAt?t.updatedAt?1:-1:t.createdAt>e.createdAt?1:t.createdAt<e.createdAt?-1:0}function je(t){const e={threads:{...t.threads},inboxNotifications:{...t.inboxNotifications},notificationSettings:{...t.notificationSettings}};for(const n of t.optimisticUpdates)switch(n.type){case"create-thread":e.threads[n.thread.id]=n.thread;break;case"edit-thread-metadata":{const t=e.threads[n.threadId];if(void 0===t)break;if(void 0!==t.deletedAt)break;if(void 0!==t.updatedAt&&t.updatedAt>n.updatedAt)break;e.threads[t.id]={...t,updatedAt:n.updatedAt,metadata:{...t.metadata,...n.metadata}};break}case"create-comment":{const t=e.threads[n.comment.threadId];if(void 0===t)break;e.threads[t.id]=$e(t,n.comment);const i=Object.values(e.inboxNotifications).find((e=>"thread"===e.kind&&e.threadId===t.id));if(void 0===i)break;e.inboxNotifications[i.id]={...i,notifiedAt:n.comment.createdAt,readAt:n.comment.createdAt};break}case"edit-comment":{const t=e.threads[n.comment.threadId];if(void 0===t)break;e.threads[t.id]=$e(t,n.comment);break}case"delete-comment":{const t=e.threads[n.threadId];if(void 0===t)break;e.threads[t.id]=He(t,n.commentId,n.deletedAt);break}case"delete-thread":if(void 0===e.threads[n.threadId])break;e.threads[n.threadId]={...e.threads[n.threadId],deletedAt:n.deletedAt,updatedAt:n.deletedAt,comments:[]};break;case"add-reaction":{const t=e.threads[n.threadId];if(void 0===t)break;e.threads[t.id]=ze(t,n.commentId,n.reaction);break}case"remove-reaction":{const t=e.threads[n.threadId];if(void 0===t)break;e.threads[t.id]=We(t,n.commentId,n.emoji,n.userId,n.removedAt);break}case"mark-inbox-notification-as-read":e.inboxNotifications[n.inboxNotificationId]={...t.inboxNotifications[n.inboxNotificationId],readAt:n.readAt};break;case"mark-inbox-notifications-as-read":for(const t in e.inboxNotifications)e.inboxNotifications[t]={...e.inboxNotifications[t],readAt:n.readAt};break;case"update-notification-settings":e.notificationSettings[n.roomId]={...e.notificationSettings[n.roomId],...n.settings}}return e}function Ke(t,e){const n={...t};return e.newThreads.forEach((t=>{const e=n[t.id];if(e){if(1===Re(e,t))return}n[t.id]=t})),e.deletedThreads.forEach((({id:t,deletedAt:e})=>{const i=n[t];void 0!==i&&(i.deletedAt=e,i.updatedAt=e,i.comments=[])})),n}function Me(t,e){const n={...t};return e.newInboxNotifications.forEach((t=>{const e=n[t.id];if(e){if(1===function(t,e){if(t.notifiedAt>e.notifiedAt)return 1;if(t.notifiedAt<e.notifiedAt)return-1;if(t.readAt&&e.readAt)return t.readAt>e.readAt?1:t.readAt<e.readAt?-1:0;if(t.readAt||e.readAt)return t.readAt?1:-1;return 0}(e,t))return}n[t.id]=t})),e.deletedNotifications.forEach((({id:t})=>delete n[t])),n}function $e(t,e){if(void 0!==t.deletedAt)return t;if(e.threadId!==t.id)return g(`Comment ${e.id} does not belong to thread ${t.id}`),t;const n=t.comments.find((t=>t.id===e.id));if(void 0===n){const n=new Date(Math.max(t.updatedAt?.getTime()||0,e.createdAt.getTime()));return{...t,updatedAt:n,comments:[...t.comments,e]}}if(void 0!==n.deletedAt)return t;if(void 0===n.editedAt||void 0===e.editedAt||n.editedAt<=e.editedAt){const n=t.comments.map((t=>t.id===e.id?e:t));return{...t,updatedAt:new Date(Math.max(t.updatedAt?.getTime()||0,e.editedAt?.getTime()||e.createdAt.getTime())),comments:n}}return t}function He(t,e,n){if(void 0!==t.deletedAt)return t;const i=t.comments.find((t=>t.id===e));if(void 0===i)return t;if(void 0!==i.deletedAt)return t;const o=t.comments.map((t=>t.id===e?{...t,deletedAt:n,body:void 0}:t));return o.some((t=>void 0===t.deletedAt))?{...t,updatedAt:n,comments:o}:{...t,deletedAt:n,updatedAt:n,comments:[]}}function ze(t,e,n){if(void 0!==t.deletedAt)return t;const i=t.comments.find((t=>t.id===e));if(void 0===i)return t;if(void 0!==i.deletedAt)return t;const o=t.comments.map((t=>t.id===e?{...t,reactions:Fe(t.reactions,n)}:t));return{...t,updatedAt:new Date(Math.max(n.createdAt.getTime(),t.updatedAt?.getTime()||0)),comments:o}}function We(t,e,n,i,o){if(void 0!==t.deletedAt)return t;const s=t.comments.find((t=>t.id===e));if(void 0===s)return t;if(void 0!==s.deletedAt)return t;const r=t.comments.map((t=>t.id===e?{...t,reactions:t.reactions.map((t=>t.emoji===n?{...t,users:t.users.filter((t=>t.id!==i))}:t)).filter((t=>t.users.length>0))}:t));return{...t,updatedAt:new Date(Math.max(o.getTime(),t.updatedAt?.getTime()||0)),comments:r}}function Fe(t,e){const n=t.find((t=>t.emoji===e.emoji));return void 0===n?[...t,{emoji:e.emoji,createdAt:e.createdAt,users:[{id:e.userId}]}]:!1===n.users.some((t=>t.id===e.userId))?t.map((t=>t.emoji===e.emoji?{...t,users:[...t.users,{id:e.userId}]}:t)):t}var Je=16,qe=1e3,Ve=100,Ge=15e3,Be=200,Ye=1e3,Xe=3e4,Ze=5e3,Qe=50,tn=50;function en(t){return"public"===t.type?t.publicApiKey:t.token.raw}function nn(t){const e=t,n=sn("throttle",e.throttle??Ve,Je,qe);const i=function(t){return sn("lostConnectionTimeout",t,Be,Xe,Ye)}(e.lostConnectionTimeout??Ze),o=function(t){return void 0===t?void 0:sn("backgroundKeepAliveTimeout",t,Ge)}(e.backgroundKeepAliveTimeout),s=function(t){return"string"===typeof t&&t.startsWith("http")?t:st}(e.baseUrl),r=ot(t),a=new Map;function c(t){const e=()=>{const n=e;var i;t.unsubs.delete(n)?0===t.unsubs.size&&((i=t.room).id,a.delete(i.id),i.destroy()):g("This leave function was already called. Calling it more than once has no effect.")};return t.unsubs.add(e),{room:t.room,leave:e}}const d=lt(null),{getInboxNotifications:u,getUnreadInboxNotificationsCount:h,markAllInboxNotificationsAsRead:l,markInboxNotificationAsRead:p}=vt({baseUrl:s,fetcher:e.polyfills?.fetch||fetch,authManager:r,currentUserIdStore:d}),m=function(){const t=lt({threads:{},queries:{},optimisticUpdates:[],inboxNotifications:{},notificationSettings:{}}),e=f();return{...t,deleteThread(e){t.set((t=>({...t,threads:Ue(t.threads,e),inboxNotifications:Object.fromEntries(Object.entries(t.inboxNotifications).filter((([t,n])=>"thread"===n.kind&&n.threadId===e)))})))},updateThreadAndNotification(e,n){t.set((t=>{const i=t.threads[e.id];return{...t,threads:void 0===i||1===Re(e,i)?{...t.threads,[e.id]:e}:t.threads,inboxNotifications:void 0===n?t.inboxNotifications:{...t.inboxNotifications,[n.id]:n}}}))},updateThreadsAndNotifications(e,n,i,o,s){t.set((t=>({...t,threads:Ke(t.threads,{newThreads:e,deletedThreads:i}),inboxNotifications:Me(t.inboxNotifications,{newInboxNotifications:n,deletedNotifications:o}),queries:void 0!==s?{...t.queries,[s]:{isLoading:!1}}:t.queries})))},updateRoomInboxNotificationSettings(e,n,i){t.set((t=>({...t,notificationSettings:{...t.notificationSettings,[e]:n},queries:{...t.queries,[i]:{isLoading:!1}}})))},pushOptimisticUpdate(n){e.notify(n),t.set((t=>({...t,optimisticUpdates:[...t.optimisticUpdates,n]})))},setQueryState(e,n){t.set((t=>({...t,queries:{...t.queries,[e]:n}})))},optimisticUpdatesEventSource:e}}(),y=e.resolveUsers,_=rn((()=>!y),"Set the resolveUsers option in createClient to specify user info."),b=ht((async t=>{const e=t.flat(),n=await(y?.({userIds:e}));return _(),n??e.map((()=>{}))}),{delay:Qe}),v=e.resolveRoomsInfo,w=rn((()=>!v),"Set the resolveRoomsInfo option in createClient to specify room info."),I=ht((async t=>{const e=t.flat(),n=await(v?.({roomIds:e}));return w(),n??e.map((()=>{}))}),{delay:tn});return Object.defineProperty({enterRoom:function(t,...d){const u=a.get(t);if(void 0!==u)return c(u);const h=d[0]??{},l=Ne({initialPresence:("function"===typeof h.initialPresence?h.initialPresence(t):h.initialPresence)??{},initialStorage:("function"===typeof h.initialStorage?h.initialStorage(t):h.initialStorage)??{}},{roomId:t,throttleDelay:n,lostConnectionTimeout:i,backgroundKeepAliveTimeout:o,polyfills:e.polyfills,delegates:e.mockedDelegates??{createSocket:Le(t,s,e.polyfills?.WebSocket),authenticate:De(t,r)},enableDebugLogging:e.enableDebugLogging,unstable_batchedUpdates:h?.unstable_batchedUpdates,baseUrl:s,unstable_fallbackToHTTP:!!e.unstable_fallbackToHTTP,unstable_streamData:!!e.unstable_streamData}),p={room:l,unsubs:new Set};if(a.set(t,p),h.autoConnect??!0){if("undefined"===typeof atob){if(void 0===e.polyfills?.atob)throw new Error("You need to polyfill atob to use the client in your environment. Please follow the instructions at https://liveblocks.io/docs/errors/liveblocks-client/atob-polyfill");global.atob=e.polyfills.atob}l.connect()}return c(p)},getRoom:function(t){const e=a.get(t)?.room;return e||null},logout:function(){r.reset();for(const{room:e}of a.values())"initial"!==(t=e.getStatus())&&"disconnected"!==t&&e.reconnect();var t},[rt]:{notifications:{getInboxNotifications:u,getUnreadInboxNotificationsCount:h,markAllInboxNotificationsAsRead:l,markInboxNotificationAsRead:p},currentUserIdStore:d,resolveMentionSuggestions:e.resolveMentionSuggestions,cacheStore:m,usersStore:b,roomsInfoStore:I,getRoomIds:()=>Array.from(a.keys())}},rt,{enumerable:!1})}var on=class extends Error{constructor(t,e,n){super(t),this.message=t,this.status=e,this.details=n}};function sn(t,e,n,i,o){if("number"!==typeof e||e<n||void 0!==i&&e>i)throw new Error(void 0!==i?`${t} should be between ${o??n} and ${i}.`:`${t} should be at least ${o??n}.`);return e}function rn(t,...e){return()=>{}}var an={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};new RegExp(Object.keys(an).map((t=>`\\${t}`)).join("|"),"g");var cn={_:"\\_","*":"\\*","#":"\\#","`":"\\`","~":"\\~","!":"\\!","|":"\\|","(":"\\(",")":"\\)","{":"\\{","}":"\\}","[":"\\[","]":"\\]"};new RegExp(Object.keys(cn).map((t=>`\\${t}`)).join("|"),"g");function dn(t){let e={state:"stopped",timeoutHandle:null,interval:null,lastScheduledAt:null,remainingInterval:null};function n(){"running"===e.state&&i(e.interval),t()}function i(t){e={state:"running",interval:"stopped"!==e.state?e.interval:t,lastScheduledAt:performance.now(),timeoutHandle:setTimeout(n,t),remainingInterval:null}}function o(t){"running"!==e.state&&i(t)}function s(){"stopped"!==e.state&&(e.timeoutHandle&&clearTimeout(e.timeoutHandle),e={state:"stopped",interval:null,lastScheduledAt:null,timeoutHandle:null,remainingInterval:null})}return{start:o,restart:function(t){s(),o(t)},pause:function(){"running"===e.state&&(clearTimeout(e.timeoutHandle),e={state:"paused",interval:e.interval,lastScheduledAt:e.lastScheduledAt,timeoutHandle:null,remainingInterval:e.interval-(performance.now()-e.lastScheduledAt)})},resume:function(){var t;"paused"===e.state&&(t=e.remainingInterval,"paused"===e.state&&(e={state:"running",interval:e.interval,lastScheduledAt:e.lastScheduledAt,timeoutHandle:setTimeout(n,t),remainingInterval:null}))},stop:s}}function un(t,e){if(Object.is(t,e))return!0;const n=Array.isArray(t),i=Array.isArray(e);return n||i?!(!n||!i)&&function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Object.is(t[n],e[n]))return!1;return!0}(t,e):function(t,e){if("object"!==typeof t||null===t||"object"!==typeof e||null===e||"[object Object]"!==Object.prototype.toString.call(t)||"[object Object]"!==Object.prototype.toString.call(e))return!1;const n=Object.keys(t);return n.length===Object.keys(e).length&&n.every((n=>Object.prototype.hasOwnProperty.call(e,n)&&Object.is(t[n],e[n])))}(t,e)}h(o,s,"esm")}}]);